
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Survival analysis &#8212; Think Stats, 3rd edition</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=87e54e7c" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=3ee479438cf8b5e0d341"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=36754332"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]]}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'chap13';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Analytic methods" href="chap14.html" />
    <link rel="prev" title="Time series analysis" href="chap12.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
  
    <p class="title logo__title">Think Stats, 3rd edition</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    Think Stats, 3rd edition
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="chap00.html">Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap01.html">Exploratory data analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap02.html">Distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap03.html">Probability mass functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap04.html">Cumulative distribution functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap05.html">Modeling distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap06.html">Probability density functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap07.html">Relationships between variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap08.html">Estimation</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap09.html">Hypothesis testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap10.html">Linear least squares</a></li>

<li class="toctree-l1"><a class="reference internal" href="chap11.html">Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap12.html">Time series analysis</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Survival analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap14.html">Analytic methods</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/AllenDowney/ThinkStats/tree/v3" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/chap13.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Survival analysis</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#survival-curves">Survival curves</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#hazard-function">Hazard function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#inferring-survival-curves">Inferring survival curves</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#kaplan-meier-estimation">Kaplan-Meier estimation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-marriage-curve">The marriage curve</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#estimating-the-survival-curve">Estimating the survival curve</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#confidence-intervals">Confidence intervals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cohort-effects">Cohort effects</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extrapolation">Extrapolation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#expected-remaining-lifetime">Expected remaining lifetime</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#glossary">Glossary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="survival-analysis">
<h1>Survival analysis<a class="headerlink" href="#survival-analysis" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> nb_black
<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 1;
                var nbb_unformatted_code = "%load_ext nb_black\n%load_ext autoreload\n%autoreload 2";
                var nbb_formatted_code = "%load_ext nb_black\n%load_ext autoreload\n%autoreload 2";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">basename</span><span class="p">,</span> <span class="n">exists</span>


<span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlretrieve</span>

        <span class="n">local</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloaded &quot;</span> <span class="o">+</span> <span class="n">local</span><span class="p">)</span>


<span class="n">download</span><span class="p">(</span><span class="s2">&quot;https://github.com/AllenDowney/ThinkStats2/raw/master/code/thinkstats2.py&quot;</span><span class="p">)</span>
<span class="n">download</span><span class="p">(</span><span class="s2">&quot;https://github.com/AllenDowney/ThinkStats2/raw/master/code/thinkplot.py&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 2;
                var nbb_unformatted_code = "from os.path import basename, exists\n\n\ndef download(url):\n    filename = basename(url)\n    if not exists(filename):\n        from urllib.request import urlretrieve\n        local, _ = urlretrieve(url, filename)\n        print('Downloaded ' + local)\n\n\ndownload(\n    'https://github.com/AllenDowney/ThinkStats2/raw/master/code/thinkstats2.py'\n    )\ndownload(\n    'https://github.com/AllenDowney/ThinkStats2/raw/master/code/thinkplot.py')";
                var nbb_formatted_code = "from os.path import basename, exists\n\n\ndef download(url):\n    filename = basename(url)\n    if not exists(filename):\n        from urllib.request import urlretrieve\n\n        local, _ = urlretrieve(url, filename)\n        print(\"Downloaded \" + local)\n\n\ndownload(\"https://github.com/AllenDowney/ThinkStats2/raw/master/code/thinkstats2.py\")\ndownload(\"https://github.com/AllenDowney/ThinkStats2/raw/master/code/thinkplot.py\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">thinkstats2</span>
<span class="kn">import</span> <span class="nn">thinkplot</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 3;
                var nbb_unformatted_code = "import thinkstats2\nimport thinkplot";
                var nbb_formatted_code = "import thinkstats2\nimport thinkplot";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 4;
                var nbb_unformatted_code = "import numpy as np\nimport pandas as pd";
                var nbb_formatted_code = "import numpy as np\nimport pandas as pd";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p><strong>Survival analysis</strong> is a way to describe how long things last. It is
often used to study human lifetimes, but it also applies to “survival”
of mechanical and electronic components, or more generally to intervals
in time before an event.</p>
<p>If someone you know has been diagnosed with a life-threatening disease,
you might have seen a “5-year survival rate,” which is the probability
of surviving five years after diagnosis. That estimate and related
statistics are the result of survival analysis.</p>
<section id="survival-curves">
<h2>Survival curves<a class="headerlink" href="#survival-curves" title="Link to this heading">#</a></h2>
<p>The fundamental concept in survival analysis is the <strong>survival curve</strong>,
<span class="math notranslate nohighlight">\(S(t)\)</span>, which is a function that maps from a duration, <span class="math notranslate nohighlight">\(t\)</span>, to the
probability of surviving longer than <span class="math notranslate nohighlight">\(t\)</span>. If you know the distribution
of durations, or “lifetimes”, finding the survival curve is easy; it’s
just the complement of the CDF: $<span class="math notranslate nohighlight">\(S(t) = 1 - CDF(t)\)</span><span class="math notranslate nohighlight">\( where \)</span>CDF(t)<span class="math notranslate nohighlight">\( is
the probability of a lifetime less than or equal to \)</span>t$.</p>
<p>For example, in the NSFG dataset, we know the duration of 11189 complete
pregnancies. We can read this data and compute the CDF:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">download</span><span class="p">(</span><span class="s2">&quot;https://github.com/AllenDowney/ThinkStats2/raw/master/code/nsfg.py&quot;</span><span class="p">)</span>
<span class="n">download</span><span class="p">(</span><span class="s2">&quot;https://github.com/AllenDowney/ThinkStats2/raw/master/code/2002FemPreg.dct&quot;</span><span class="p">)</span>
<span class="n">download</span><span class="p">(</span>
    <span class="s2">&quot;https://github.com/AllenDowney/ThinkStats2/raw/master/code/2002FemPreg.dat.gz&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 5;
                var nbb_unformatted_code = "download('https://github.com/AllenDowney/ThinkStats2/raw/master/code/nsfg.py')\ndownload(\n    'https://github.com/AllenDowney/ThinkStats2/raw/master/code/2002FemPreg.dct'\n    )\ndownload(\n    'https://github.com/AllenDowney/ThinkStats2/raw/master/code/2002FemPreg.dat.gz'\n    )";
                var nbb_formatted_code = "download(\"https://github.com/AllenDowney/ThinkStats2/raw/master/code/nsfg.py\")\ndownload(\"https://github.com/AllenDowney/ThinkStats2/raw/master/code/2002FemPreg.dct\")\ndownload(\n    \"https://github.com/AllenDowney/ThinkStats2/raw/master/code/2002FemPreg.dat.gz\"\n)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">nsfg</span>

<span class="n">preg</span> <span class="o">=</span> <span class="n">nsfg</span><span class="o">.</span><span class="n">read_fem_preg</span><span class="p">()</span>
<span class="n">complete</span> <span class="o">=</span> <span class="n">preg</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;outcome in [1, 3, 4]&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">prglngth</span>
<span class="n">cdf</span> <span class="o">=</span> <span class="n">thinkstats2</span><span class="o">.</span><span class="n">Cdf</span><span class="p">(</span><span class="n">complete</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;cdf&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 6;
                var nbb_unformatted_code = "import nsfg\npreg = nsfg.read_fem_preg()\ncomplete = preg.query('outcome in [1, 3, 4]').prglngth\ncdf = thinkstats2.Cdf(complete, label='cdf')";
                var nbb_formatted_code = "import nsfg\n\npreg = nsfg.read_fem_preg()\ncomplete = preg.query(\"outcome in [1, 3, 4]\").prglngth\ncdf = thinkstats2.Cdf(complete, label=\"cdf\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The outcome codes <code class="docutils literal notranslate"><span class="pre">1,</span> <span class="pre">3,</span> <span class="pre">4</span></code> indicate live birth, stillbirth, and
miscarriage. For this analysis I am excluding induced abortions, ectopic
pregnancies, and pregnancies that were in progress when the respondent
was interviewed.</p>
<p>The DataFrame method <code class="docutils literal notranslate"><span class="pre">query</span></code> takes a boolean expression and evaluates it
for each row, selecting the rows that yield True.</p>
<p>Figure <a class="reference internal" href="#survival1"><span class="xref myst">[survival1]</span></a>{reference-type=“ref”
reference=“survival1”} (top) shows the CDF of pregnancy length and its
complement, the survival curve. To represent the survival curve, I
define an object that wraps a Cdf and adapts the interface:</p>
<p><code class="docutils literal notranslate"><span class="pre">SurvivalFunction</span></code> provides two properties: <code class="docutils literal notranslate"><span class="pre">ts</span></code>, which is the sequence
of lifetimes, and <code class="docutils literal notranslate"><span class="pre">ss</span></code>, which is the survival curve. In Python, a
“property” is a method that can be invoked as if it were a variable.</p>
<p>We can instantiate a <code class="docutils literal notranslate"><span class="pre">SurvivalFunction</span></code> by passing the CDF of lifetimes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">thinkstats2</span> <span class="kn">import</span> <span class="n">SurvivalFunction</span>


<span class="k">def</span> <span class="nf">make_survival_from_cdf</span><span class="p">(</span><span class="n">cdf</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Makes a survival function based on a CDF.</span>

<span class="sd">    cdf: Cdf</span>

<span class="sd">    returns: SurvivalFunction</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">cdf</span><span class="o">.</span><span class="n">xs</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">cdf</span><span class="o">.</span><span class="n">ps</span>
    <span class="k">return</span> <span class="n">SurvivalFunction</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">ss</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 7;
                var nbb_unformatted_code = "from thinkstats2 import SurvivalFunction\n\n\ndef make_survival_from_cdf(cdf, label=''):\n    \"\"\"Makes a survival function based on a CDF.\n\n    cdf: Cdf\n\n    returns: SurvivalFunction\n    \"\"\"\n    ts = cdf.xs\n    ss = 1 - cdf.ps\n    return SurvivalFunction(ts, ss, label)";
                var nbb_formatted_code = "from thinkstats2 import SurvivalFunction\n\n\ndef make_survival_from_cdf(cdf, label=\"\"):\n    \"\"\"Makes a survival function based on a CDF.\n\n    cdf: Cdf\n\n    returns: SurvivalFunction\n    \"\"\"\n    ts = cdf.xs\n    ss = 1 - cdf.ps\n    return SurvivalFunction(ts, ss, label)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sf</span> <span class="o">=</span> <span class="n">make_survival_from_cdf</span><span class="p">(</span><span class="n">cdf</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;survival&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 8;
                var nbb_unformatted_code = "sf = make_survival_from_cdf(cdf, label='survival')";
                var nbb_formatted_code = "sf = make_survival_from_cdf(cdf, label=\"survival\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">SurvivalFunction</span></code> also provides <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code> and <code class="docutils literal notranslate"><span class="pre">Prob</span></code>, which
evaluates the survival curve:</p>
<p>For example, <code class="docutils literal notranslate"><span class="pre">sf[13]</span></code> is the fraction of pregnancies that proceed past
the first trimester:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sf</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8602198587898829
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 9;
                var nbb_unformatted_code = "sf[13]";
                var nbb_formatted_code = "sf[13]";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cdf</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.1397801412101171
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 10;
                var nbb_unformatted_code = "cdf[13]";
                var nbb_formatted_code = "cdf[13]";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>About 86% of pregnancies proceed past the first trimester; about 14% do
not.</p>
<p><code class="docutils literal notranslate"><span class="pre">SurvivalFunction</span></code> provides <code class="docutils literal notranslate"><span class="pre">Render</span></code>, so we can plot <code class="docutils literal notranslate"><span class="pre">sf</span></code> using the
functions in <code class="docutils literal notranslate"><span class="pre">thinkplot</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">thinkplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span>
<span class="n">thinkplot</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">cdf</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">thinkplot</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center left&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">thinkplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">thinkplot</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">cdf</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">thinkplot</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">)</span>

<span class="nn">File ~/ThinkStats/soln/thinkplot.py:208,</span> in <span class="ni">plot</span><span class="nt">(obj, ys, style, **options)</span>
<span class="g g-Whitespace">    </span><span class="mi">206</span>         <span class="n">xs</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">index</span>
<span class="g g-Whitespace">    </span><span class="mi">207</span> <span class="k">if</span> <span class="n">ys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">208</span>     <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">style</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">209</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">210</span>     <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">style</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

<span class="nn">File ~/miniconda3/envs/ThinkStats/lib/python3.10/site-packages/matplotlib/pyplot.py:3708,</span> in <span class="ni">plot</span><span class="nt">(scalex, scaley, data, *args, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">3700</span> <span class="nd">@_copy_docstring_and_deprecators</span><span class="p">(</span><span class="n">Axes</span><span class="o">.</span><span class="n">plot</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">3701</span> <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">3702</span>     <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">3706</span>     <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">3707</span> <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Line2D</span><span class="p">]:</span>
<span class="ne">-&gt; </span><span class="mi">3708</span>     <span class="k">return</span> <span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">3709</span>         <span class="o">*</span><span class="n">args</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">3710</span>         <span class="n">scalex</span><span class="o">=</span><span class="n">scalex</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">3711</span>         <span class="n">scaley</span><span class="o">=</span><span class="n">scaley</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">3712</span>         <span class="o">**</span><span class="p">({</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">}</span> <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}),</span>
<span class="g g-Whitespace">   </span><span class="mi">3713</span>         <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">3714</span>     <span class="p">)</span>

<span class="nn">File ~/miniconda3/envs/ThinkStats/lib/python3.10/site-packages/matplotlib/axes/_axes.py:1779,</span> in <span class="ni">Axes.plot</span><span class="nt">(self, scalex, scaley, data, *args, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1536</span><span class="w"> </span><span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">   </span><span class="mi">1537</span><span class="sd"> Plot y versus x as lines and/or markers.</span>
<span class="g g-Whitespace">   </span><span class="mi">1538</span><span class="sd"> </span>
<span class="sd">   (...)</span>
<span class="g g-Whitespace">   </span><span class="mi">1776</span><span class="sd"> (``&#39;green&#39;``) or hex strings (``&#39;#008000&#39;``).</span>
<span class="g g-Whitespace">   </span><span class="mi">1777</span><span class="sd"> &quot;&quot;&quot;</span>
<span class="g g-Whitespace">   </span><span class="mi">1778</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">cbook</span><span class="o">.</span><span class="n">normalize_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">mlines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">1779</span> <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)]</span>
<span class="g g-Whitespace">   </span><span class="mi">1780</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1781</span>     <span class="bp">self</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

<span class="nn">File ~/miniconda3/envs/ThinkStats/lib/python3.10/site-packages/matplotlib/axes/_base.py:296,</span> in <span class="ni">_process_plot_var_args.__call__</span><span class="nt">(self, axes, data, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">294</span>     <span class="n">this</span> <span class="o">+=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<span class="g g-Whitespace">    </span><span class="mi">295</span>     <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="ne">--&gt; </span><span class="mi">296</span> <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_args</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">297</span>     <span class="n">axes</span><span class="p">,</span> <span class="n">this</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">ambiguous_fmt_datakey</span><span class="o">=</span><span class="n">ambiguous_fmt_datakey</span><span class="p">)</span>

<span class="nn">File ~/miniconda3/envs/ThinkStats/lib/python3.10/site-packages/matplotlib/axes/_base.py:478,</span> in <span class="ni">_process_plot_var_args._plot_args</span><span class="nt">(self, axes, tup, kwargs, return_kwargs, ambiguous_fmt_datakey)</span>
<span class="g g-Whitespace">    </span><span class="mi">476</span>     <span class="n">y</span> <span class="o">=</span> <span class="n">_check_1d</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="g g-Whitespace">    </span><span class="mi">477</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">478</span>     <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">index_of</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="g g-Whitespace">    </span><span class="mi">480</span> <span class="k">if</span> <span class="n">axes</span><span class="o">.</span><span class="n">xaxis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">481</span>     <span class="n">axes</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">update_units</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="nn">File ~/miniconda3/envs/ThinkStats/lib/python3.10/site-packages/matplotlib/cbook.py:1719,</span> in <span class="ni">index_of</span><span class="nt">(y)</span>
<span class="g g-Whitespace">   </span><span class="mi">1717</span>     <span class="k">pass</span>
<span class="g g-Whitespace">   </span><span class="mi">1718</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1719</span>     <span class="n">y</span> <span class="o">=</span> <span class="n">_check_1d</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1720</span> <span class="k">except</span> <span class="p">(</span><span class="n">VisibleDeprecationWarning</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1721</span>     <span class="c1"># NumPy 1.19 will warn on ragged input, and we can&#39;t actually use it.</span>
<span class="g g-Whitespace">   </span><span class="mi">1722</span>     <span class="k">pass</span>

<span class="nn">File ~/miniconda3/envs/ThinkStats/lib/python3.10/site-packages/matplotlib/cbook.py:1411,</span> in <span class="ni">_check_1d</span><span class="nt">(x)</span>
<span class="g g-Whitespace">   </span><span class="mi">1405</span> <span class="c1"># plot requires `shape` and `ndim`.  If passed an</span>
<span class="g g-Whitespace">   </span><span class="mi">1406</span> <span class="c1"># object that doesn&#39;t provide them, then force to numpy array.</span>
<span class="g g-Whitespace">   </span><span class="mi">1407</span> <span class="c1"># Note this will strip unit information.</span>
<span class="g g-Whitespace">   </span><span class="mi">1408</span> <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">)</span> <span class="ow">or</span>
<span class="g g-Whitespace">   </span><span class="mi">1409</span>         <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;ndim&#39;</span><span class="p">)</span> <span class="ow">or</span>
<span class="g g-Whitespace">   </span><span class="mi">1410</span>         <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
<span class="ne">-&gt; </span><span class="mi">1411</span>     <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1412</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1413</span>     <span class="k">return</span> <span class="n">x</span>

<span class="nn">File ~/miniconda3/envs/ThinkStats/lib/python3.10/site-packages/numpy/core/shape_base.py:65,</span> in <span class="ni">atleast_1d</span><span class="nt">(*arys)</span>
<span class="g g-Whitespace">     </span><span class="mi">63</span> <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
<span class="g g-Whitespace">     </span><span class="mi">64</span> <span class="k">for</span> <span class="n">ary</span> <span class="ow">in</span> <span class="n">arys</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">65</span>     <span class="n">ary</span> <span class="o">=</span> <span class="n">asanyarray</span><span class="p">(</span><span class="n">ary</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">66</span>     <span class="k">if</span> <span class="n">ary</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">67</span>         <span class="n">result</span> <span class="o">=</span> <span class="n">ary</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="nn">File ~/ThinkStats/soln/thinkstats2.py:3804,</span> in <span class="ni">SurvivalFunction.__getitem__</span><span class="nt">(self, t)</span>
<span class="g g-Whitespace">   </span><span class="mi">3803</span> <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="ne">-&gt; </span><span class="mi">3804</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prob</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

<span class="nn">File ~/ThinkStats/soln/thinkstats2.py:3811,</span> in <span class="ni">SurvivalFunction.prob</span><span class="nt">(self, t)</span>
<span class="g g-Whitespace">   </span><span class="mi">3806</span> <span class="k">def</span> <span class="nf">prob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">3807</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;Returns S(t), the probability that corresponds to value t.</span>
<span class="g g-Whitespace">   </span><span class="mi">3808</span><span class="sd">     t: time</span>
<span class="g g-Whitespace">   </span><span class="mi">3809</span><span class="sd">     returns: float probability</span>
<span class="g g-Whitespace">   </span><span class="mi">3810</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="ne">-&gt; </span><span class="mi">3811</span>     <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ss</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

<span class="nn">File ~/miniconda3/envs/ThinkStats/lib/python3.10/site-packages/numpy/lib/function_base.py:1599,</span> in <span class="ni">interp</span><span class="nt">(x, xp, fp, left, right, period)</span>
<span class="g g-Whitespace">   </span><span class="mi">1596</span>     <span class="n">xp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">xp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">period</span><span class="p">,</span> <span class="n">xp</span><span class="p">,</span> <span class="n">xp</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">period</span><span class="p">))</span>
<span class="g g-Whitespace">   </span><span class="mi">1597</span>     <span class="n">fp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">fp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:],</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fp</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]))</span>
<span class="ne">-&gt; </span><span class="mi">1599</span> <span class="k">return</span> <span class="n">interp_func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
<img alt="_images/169be4011b29a303724f83e418f7dc2df054cf23a9104843b87f6fdb32819f59.png" src="_images/169be4011b29a303724f83e418f7dc2df054cf23a9104843b87f6fdb32819f59.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 11;
                var nbb_unformatted_code = "thinkplot.plot(sf)\nthinkplot.cdf(cdf, alpha=0.2)\nthinkplot.config(loc='center left')";
                var nbb_formatted_code = "thinkplot.plot(sf)\nthinkplot.cdf(cdf, alpha=0.2)\nthinkplot.config(loc=\"center left\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Figure <a class="reference internal" href="#survival1"><span class="xref myst">[survival1]</span></a>{reference-type=“ref”
reference=“survival1”} (top) shows the result. The curve is nearly flat
between 13 and 26 weeks, which shows that few pregnancies end in the
second trimester. And the curve is steepest around 39 weeks, which is
the most common pregnancy length.</p>
</section>
<section id="hazard-function">
<h2>Hazard function<a class="headerlink" href="#hazard-function" title="Link to this heading">#</a></h2>
<p>From the survival curve we can derive the <strong>hazard function</strong>; for
pregnancy lengths, the hazard function maps from a time, <span class="math notranslate nohighlight">\(t\)</span>, to the
fraction of pregnancies that continue until <span class="math notranslate nohighlight">\(t\)</span> and then end at <span class="math notranslate nohighlight">\(t\)</span>. To
be more precise: $<span class="math notranslate nohighlight">\(\lambda(t) = \frac{S(t) - S(t+1)}{S(t)}\)</span><span class="math notranslate nohighlight">\( The
numerator is the fraction of lifetimes that end at \)</span>t<span class="math notranslate nohighlight">\(, which is also
\)</span>\PMF(t)$.</p>
<p><code class="docutils literal notranslate"><span class="pre">SurvivalFunction</span></code> provides <code class="docutils literal notranslate"><span class="pre">MakeHazard</span></code>, which calculates the hazard
function:</p>
<p>The <code class="docutils literal notranslate"><span class="pre">HazardFunction</span></code> object is a wrapper for a pandas Series:</p>
<p><code class="docutils literal notranslate"><span class="pre">d</span></code> can be a dictionary or any other type that can initialize a Series,
including another Series. <code class="docutils literal notranslate"><span class="pre">label</span></code> is a string used to identify the
HazardFunction when plotted.</p>
<p><code class="docutils literal notranslate"><span class="pre">HazardFunction</span></code> provides <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code>, so we can evaluate it like
this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hf</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">make_hazard_function</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;hazard&#39;</span><span class="p">)</span>
<span class="n">hf</span><span class="p">[</span><span class="mi">39</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>So of all pregnancies that proceed until week 39, about 50% end in week
39.</p>
<p>Figure <a class="reference internal" href="#survival1"><span class="xref myst">[survival1]</span></a>{reference-type=“ref”
reference=“survival1”} (bottom) shows the hazard function for pregnancy
lengths. For times after week 42, the hazard function is erratic because
it is based on a small number of cases. Other than that the shape of the
curve is as expected: it is highest around 39 weeks, and a little higher
in the first trimester than in the second.</p>
<p>The hazard function is useful in its own right, but it is also an
important tool for estimating survival curves, as we’ll see in the next
section.</p>
</section>
<section id="inferring-survival-curves">
<h2>Inferring survival curves<a class="headerlink" href="#inferring-survival-curves" title="Link to this heading">#</a></h2>
<p>If someone gives you the CDF of lifetimes, it is easy to compute the
survival and hazard functions. But in many real-world scenarios, we
can’t measure the distribution of lifetimes directly. We have to infer
it.</p>
<p>For example, suppose you are following a group of patients to see how
long they survive after diagnosis. Not all patients are diagnosed on the
same day, so at any point in time, some patients have survived longer
than others. If some patients have died, we know their survival times.
For patients who are still alive, we don’t know survival times, but we
have a lower bound.</p>
<p>If we wait until all patients are dead, we can compute the survival
curve, but if we are evaluating the effectiveness of a new treatment, we
can’t wait that long! We need a way to estimate survival curves using
incomplete information.</p>
<p>As a more cheerful example, I will use NSFG data to quantify how long
respondents “survive” until they get married for the first time. The
range of respondents’ ages is 14 to 44 years, so the dataset provides a
snapshot of women at different stages in their lives.</p>
<p>For women who have been married, the dataset includes the date of their
first marriage and their age at the time. For women who have not been
married, we know their age when interviewed, but have no way of knowing
when or if they will get married.</p>
<p>Since we know the age at first marriage for <em>some</em> women, it might be
tempting to exclude the rest and compute the CDF of the known data. That
is a bad idea. The result would be doubly misleading: (1) older women
would be overrepresented, because they are more likely to be married
when interviewed, and (2) married women would be overrepresented! In
fact, this analysis would lead to the conclusion that all women get
married, which is obviously incorrect.</p>
</section>
<section id="kaplan-meier-estimation">
<h2>Kaplan-Meier estimation<a class="headerlink" href="#kaplan-meier-estimation" title="Link to this heading">#</a></h2>
<p>In this example it is not only desirable but necessary to include
observations of unmarried women, which brings us to one of the central
algorithms in survival analysis, <strong>Kaplan-Meier estimation</strong>.</p>
<p>The general idea is that we can use the data to estimate the hazard
function, then convert the hazard function to a survival curve. To
estimate the hazard function, we consider, for each age, (1) the number
of women who got married at that age and (2) the number of women “at
risk” of getting married, which includes all women who were not married
at an earlier age.</p>
<p>Here’s the code:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">thinkstats2</span> <span class="kn">import</span> <span class="n">HazardFunction</span>


<span class="k">def</span> <span class="nf">estimate_hazard_function</span><span class="p">(</span><span class="n">complete</span><span class="p">,</span> <span class="n">ongoing</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Estimates the hazard function by Kaplan-Meier.</span>

<span class="sd">    http://en.wikipedia.org/wiki/Kaplan%E2%80%93Meier_estimator</span>

<span class="sd">    complete: list of complete lifetimes</span>
<span class="sd">    ongoing: list of ongoing lifetimes</span>
<span class="sd">    label: string</span>
<span class="sd">    verbose: whether to display intermediate results</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">complete</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;complete contains NaNs&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ongoing</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ongoing contains NaNs&#39;</span><span class="p">)</span>
    <span class="n">hist_complete</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">complete</span><span class="p">)</span>
    <span class="n">hist_ongoing</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">ongoing</span><span class="p">)</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hist_complete</span> <span class="o">|</span> <span class="n">hist_ongoing</span><span class="p">)</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">at_risk</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">complete</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">ongoing</span><span class="p">)</span>
    <span class="n">lams</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">ts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ts</span><span class="p">:</span>
        <span class="n">ended</span> <span class="o">=</span> <span class="n">hist_complete</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
        <span class="n">censored</span> <span class="o">=</span> <span class="n">hist_ongoing</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
        <span class="n">lams</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">ended</span> <span class="o">/</span> <span class="n">at_risk</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">at_risk</span><span class="p">,</span> <span class="n">ended</span><span class="p">,</span> <span class="n">censored</span><span class="p">,</span> <span class="n">lams</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
        <span class="n">at_risk</span> <span class="o">-=</span> <span class="n">ended</span> <span class="o">+</span> <span class="n">censored</span>
    <span class="k">return</span> <span class="n">HazardFunction</span><span class="p">(</span><span class="n">lams</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">complete</span></code> is the set of complete observations; in this case, the ages
when respondents got married. <code class="docutils literal notranslate"><span class="pre">ongoing</span></code> is the set of incomplete
observations; that is, the ages of unmarried women when they were
interviewed.</p>
<p>First, we precompute <code class="docutils literal notranslate"><span class="pre">hist_complete</span></code>, which is a Counter that maps from
each age to the number of women married at that age, and <code class="docutils literal notranslate"><span class="pre">hist_ongoing</span></code>
which maps from each age to the number of unmarried women interviewed at
that age.</p>
<p><code class="docutils literal notranslate"><span class="pre">ts</span></code> is the union of ages when respondents got married and ages when
unmarried women were interviewed, sorted in increasing order.</p>
<p><code class="docutils literal notranslate"><span class="pre">at_risk</span></code> keeps track of the number of respondents considered “at risk”
at each age; initially, it is the total number of respondents.</p>
<p>The result is stored in a Pandas <code class="docutils literal notranslate"><span class="pre">Series</span></code> that maps from each age to the
estimated hazard function at that age.</p>
<p>Each time through the loop, we consider one age, <code class="docutils literal notranslate"><span class="pre">t</span></code>, and compute the
number of events that end at <code class="docutils literal notranslate"><span class="pre">t</span></code> (that is, the number of respondents
married at that age) and the number of events censored at <code class="docutils literal notranslate"><span class="pre">t</span></code> (that is,
the number of women interviewed at <code class="docutils literal notranslate"><span class="pre">t</span></code> whose future marriage dates are
censored). In this context, “censored” means that the data are
unavailable because of the data collection process.</p>
<p>The estimated hazard function is the fraction of the cases at risk that
end at <code class="docutils literal notranslate"><span class="pre">t</span></code>.</p>
<p>At the end of the loop, we subtract from <code class="docutils literal notranslate"><span class="pre">at_risk</span></code> the number of cases
that ended or were censored at <code class="docutils literal notranslate"><span class="pre">t</span></code>.</p>
<p>Finally, we pass <code class="docutils literal notranslate"><span class="pre">lams</span></code> to the <code class="docutils literal notranslate"><span class="pre">HazardFunction</span></code> constructor and return
the result.</p>
</section>
<section id="the-marriage-curve">
<h2>The marriage curve<a class="headerlink" href="#the-marriage-curve" title="Link to this heading">#</a></h2>
<p>To test this function, we have to do some data cleaning and
transformation. The NSFG variables we need are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">cmbirth</span></code>: The respondent’s date of birth, known for all
respondents.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cmintvw</span></code>: The date the respondent was interviewed, known for all
respondents.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cmmarrhx</span></code>: The date the respondent was first married, if applicable
and known.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">evrmarry</span></code>: 1 if the respondent had been married prior to the date
of interview, 0 otherwise.</p></li>
</ul>
<p>The first three variables are encoded in “century-months”; that is, the
integer number of months since December 1899. So century-month 1 is
January 1900.</p>
<p>First, we read the respondent file and replace invalid values of
<code class="docutils literal notranslate"><span class="pre">cmmarrhx</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">nsfg</span>
<span class="n">resp</span> <span class="o">=</span> <span class="n">nsfg</span><span class="o">.</span><span class="n">read_fem_resp</span><span class="p">()</span>
<span class="n">resp</span><span class="p">[</span><span class="s1">&#39;cmmarrhx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">cmmarrhx</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="mi">9997</span><span class="p">,</span> <span class="mi">9998</span><span class="p">,</span> <span class="mi">9999</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Then we compute each respondent’s age when married and age when
interviewed:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">resp</span><span class="p">[</span><span class="s1">&#39;agemarry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">cmmarrhx</span> <span class="o">-</span> <span class="n">resp</span><span class="o">.</span><span class="n">cmbirth</span><span class="p">)</span> <span class="o">/</span> <span class="mf">12.0</span>
<span class="n">resp</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">cmintvw</span> <span class="o">-</span> <span class="n">resp</span><span class="o">.</span><span class="n">cmbirth</span><span class="p">)</span> <span class="o">/</span> <span class="mf">12.0</span>
</pre></div>
</div>
</div>
</div>
<p>Next we extract <code class="docutils literal notranslate"><span class="pre">complete</span></code>, which is the age at marriage for women who
have been married, and <code class="docutils literal notranslate"><span class="pre">ongoing</span></code>, which is the age at interview for
women who have not:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">complete</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="n">resp</span><span class="o">.</span><span class="n">evrmarry</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">agemarry</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">ongoing</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="n">resp</span><span class="o">.</span><span class="n">evrmarry</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">age</span>
</pre></div>
</div>
</div>
</div>
<p>Finally we compute the hazard function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hf</span> <span class="o">=</span> <span class="n">estimate_hazard_function</span><span class="p">(</span><span class="n">complete</span><span class="p">,</span> <span class="n">ongoing</span><span class="p">)</span>
<span class="n">thinkplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hf</span><span class="p">)</span>
<span class="n">thinkplot</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Age (years)&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Hazard&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Figure <a class="reference internal" href="#survival2"><span class="xref myst">[survival2]</span></a>{reference-type=“ref”
reference=“survival2”} (top) shows the estimated hazard function; it is
low in the teens, higher in the 20s, and declining in the 30s. It
increases again in the 40s, but that is an artifact of the estimation
process; as the number of respondents “at risk” decreases, a small
number of women getting married yields a large estimated hazard. The
survival curve will smooth out this noise.</p>
</section>
<section id="estimating-the-survival-curve">
<h2>Estimating the survival curve<a class="headerlink" href="#estimating-the-survival-curve" title="Link to this heading">#</a></h2>
<p>Once we have the hazard function, we can estimate the survival curve.
The chance of surviving past time <code class="docutils literal notranslate"><span class="pre">t</span></code> is the chance of surviving all
times up through <code class="docutils literal notranslate"><span class="pre">t</span></code>, which is the cumulative product of the
complementary hazard function:
$<span class="math notranslate nohighlight">\([1-\lambda(0)] [1-\lambda(1)] \ldots [1-\lambda(t)]\)</span>$ The
<code class="docutils literal notranslate"><span class="pre">HazardFunction</span></code> class provides <code class="docutils literal notranslate"><span class="pre">MakeSurvival</span></code>, which computes this
product:</p>
<p><code class="docutils literal notranslate"><span class="pre">ts</span></code> is the sequence of times where the hazard function is estimated.
<code class="docutils literal notranslate"><span class="pre">ss</span></code> is the cumulative product of the complementary hazard function, so
it is the survival curve.</p>
<p>Because of the way <code class="docutils literal notranslate"><span class="pre">SurvivalFunction</span></code> is implemented, we have to compute
the complement of <code class="docutils literal notranslate"><span class="pre">ss</span></code>, make a Cdf, and then instantiate a
SurvivalFunction object.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sf</span> <span class="o">=</span> <span class="n">hf</span><span class="o">.</span><span class="n">make_survival</span><span class="p">()</span>
<span class="n">thinkplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span>
<span class="n">thinkplot</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Age (years)&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Prob unmarried&#39;</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>Figure <a class="reference internal" href="#survival2"><span class="xref myst">[survival2]</span></a>{reference-type=“ref”
reference=“survival2”} (bottom) shows the result. The survival curve is
steepest between 25 and 35, when most women get married. Between 35 and
45, the curve is nearly flat, indicating that women who do not marry
before age 35 are unlikely to get married.</p>
<p>A curve like this was the basis of a famous magazine article in 1986;
<em>Newsweek</em> reported that a 40-year old unmarried woman was “more likely
to be killed by a terrorist” than get married. These statistics were
widely reported and became part of popular culture, but they were wrong
then (because they were based on faulty analysis) and turned out to be
even more wrong (because of cultural changes that were already in
progress and continued). In 2006, <em>Newsweek</em> ran an another article
admitting that they were wrong.</p>
<p>I encourage you to read more about this article, the statistics it was
based on, and the reaction. It should remind you of the ethical
obligation to perform statistical analysis with care, interpret the
results with appropriate skepticism, and present them to the public
accurately and honestly.</p>
</section>
<section id="confidence-intervals">
<h2>Confidence intervals<a class="headerlink" href="#confidence-intervals" title="Link to this heading">#</a></h2>
<p>Kaplan-Meier analysis yields a single estimate of the survival curve,
but it is also important to quantify the uncertainty of the estimate. As
usual, there are three possible sources of error: measurement error,
sampling error, and modeling error.</p>
<p>In this example, measurement error is probably small. People generally
know when they were born, whether they’ve been married, and when. And
they can be expected to report this information accurately.</p>
<p>We can quantify sampling error by resampling. Here’s the code:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">estimate_marriage_survival</span><span class="p">(</span><span class="n">resp</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Estimates the survival curve.</span>

<span class="sd">    resp: DataFrame of respondents</span>

<span class="sd">    returns: pair of HazardFunction, SurvivalFunction</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">complete</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="n">resp</span><span class="o">.</span><span class="n">evrmarry</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">agemarry</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="n">ongoing</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="n">resp</span><span class="o">.</span><span class="n">evrmarry</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">age</span>
    <span class="n">hf</span> <span class="o">=</span> <span class="n">estimate_hazard_function</span><span class="p">(</span><span class="n">complete</span><span class="p">,</span> <span class="n">ongoing</span><span class="p">)</span>
    <span class="n">sf</span> <span class="o">=</span> <span class="n">hf</span><span class="o">.</span><span class="n">make_survival</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">hf</span><span class="p">,</span> <span class="n">sf</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">resample_survival</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">iters</span><span class="o">=</span><span class="mi">101</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Resamples respondents and estimates the survival function.</span>

<span class="sd">    resp: DataFrame of respondents</span>
<span class="sd">    iters: number of resamples</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">sf</span> <span class="o">=</span> <span class="n">estimate_marriage_survival</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
    <span class="n">thinkplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span>
    <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">agemarry</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">resp</span><span class="o">.</span><span class="n">agemarry</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mf">12.0</span><span class="p">)</span>
    <span class="n">ss_seq</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iters</span><span class="p">):</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="n">thinkstats2</span><span class="o">.</span><span class="n">resample_rows_weighted</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">sf</span> <span class="o">=</span> <span class="n">estimate_marriage_survival</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
        <span class="n">ss_seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">probs</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span>
    <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="n">thinkstats2</span><span class="o">.</span><span class="n">percentile_rows</span><span class="p">(</span><span class="n">ss_seq</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">95</span><span class="p">])</span>
    <span class="n">thinkplot</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;90% CI&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">ResampleSurvival</span></code> takes <code class="docutils literal notranslate"><span class="pre">resp</span></code>, a DataFrame of respondents, and
<code class="docutils literal notranslate"><span class="pre">iters</span></code>, the number of times to resample. It computes <code class="docutils literal notranslate"><span class="pre">ts</span></code>, which is the
sequence of ages where we will evaluate the survival curves.</p>
<p>Inside the loop, <code class="docutils literal notranslate"><span class="pre">ResampleSurvival</span></code>:</p>
<ul class="simple">
<li><p>Resamples the respondents using <code class="docutils literal notranslate"><span class="pre">ResampleRowsWeighted</span></code>, which we saw
in Section <a class="reference internal" href="#weighted"><span class="xref myst">[weighted]</span></a>{reference-type=“ref”
reference=“weighted”}.</p></li>
<li><p>Calls <code class="docutils literal notranslate"><span class="pre">EstimateSurvival</span></code>, which uses the process in the previous
sections to estimate the hazard and survival curves, and</p></li>
<li><p>Evaluates the survival curve at each age in <code class="docutils literal notranslate"><span class="pre">ts</span></code>.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">ss_seq</span></code> is a sequence of evaluated survival curves. <code class="docutils literal notranslate"><span class="pre">PercentileRows</span></code>
takes this sequence and computes the 5th and 95th percentiles, returning
a 90% confidence interval for the survival curve.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">resample_survival</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
<span class="n">thinkplot</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Age (years)&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Prob unmarried&#39;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="mi">12</span><span class="p">,</span> 
    <span class="mi">46</span><span class="p">],</span> <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Figure <a class="reference internal" href="#survival3"><span class="xref myst">[survival3]</span></a>{reference-type=“ref”
reference=“survival3”} shows the result along with the survival curve we
estimated in the previous section. The confidence interval takes into
account the sampling weights, unlike the estimated curve. The
discrepancy between them indicates that the sampling weights have a
substantial effect on the estimate—we will have to keep that in mind.</p>
</section>
<section id="cohort-effects">
<h2>Cohort effects<a class="headerlink" href="#cohort-effects" title="Link to this heading">#</a></h2>
<p>One of the challenges of survival analysis is that different parts of
the estimated curve are based on different groups of respondents. The
part of the curve at time <code class="docutils literal notranslate"><span class="pre">t</span></code> is based on respondents whose age was at
least <code class="docutils literal notranslate"><span class="pre">t</span></code> when they were interviewed. So the leftmost part of the curve
includes data from all respondents, but the rightmost part includes only
the oldest respondents.</p>
<p>If the relevant characteristics of the respondents are not changing over
time, that’s fine, but in this case it seems likely that marriage
patterns are different for women born in different generations. We can
investigate this effect by grouping respondents according to their
decade of birth. Groups like this, defined by date of birth or similar
events, are called <strong>cohorts</strong>, and differences between the groups are
called <strong>cohort effects</strong>.</p>
<p>To investigate cohort effects in the NSFG marriage data, I gathered the
Cycle 6 data from 2002 used throughout this book; the Cycle 7 data from
2006–2010 used in
Section <a class="reference internal" href="#replication"><span class="xref myst">[replication]</span></a>{reference-type=“ref”
reference=“replication”}; and the Cycle 5 data from 1995. In total these
datasets include 30,769 respondents.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">download</span><span class="p">(</span>
    <span class="s1">&#39;https://github.com/AllenDowney/ThinkStats2/raw/master/code/1995FemRespData.dat.gz&#39;</span>
    <span class="p">)</span>
<span class="n">download</span><span class="p">(</span>
    <span class="s1">&#39;https://github.com/AllenDowney/ThinkStats2/raw/master/code/2006_2010_FemRespSetup.dct&#39;</span>
    <span class="p">)</span>
<span class="n">download</span><span class="p">(</span>
    <span class="s1">&#39;https://github.com/AllenDowney/ThinkStats2/raw/master/code/2006_2010_FemResp.dat.gz&#39;</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">resp5</span> <span class="o">=</span> <span class="n">nsfg</span><span class="o">.</span><span class="n">read_fem_resp1995</span><span class="p">()</span>
<span class="n">resp6</span> <span class="o">=</span> <span class="n">nsfg</span><span class="o">.</span><span class="n">read_fem_resp2002</span><span class="p">()</span>
<span class="n">resp7</span> <span class="o">=</span> <span class="n">nsfg</span><span class="o">.</span><span class="n">read_fem_resp2010</span><span class="p">()</span>
<span class="n">resps</span> <span class="o">=</span> <span class="p">[</span><span class="n">resp5</span><span class="p">,</span> <span class="n">resp6</span><span class="p">,</span> <span class="n">resp7</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>For each DataFrame, <code class="docutils literal notranslate"><span class="pre">resp</span></code>, I use <code class="docutils literal notranslate"><span class="pre">cmbirth</span></code> to compute the decade of
birth for each respondent:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">month0</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s1">&#39;1899-12-15&#39;</span><span class="p">)</span>
<span class="n">dates</span> <span class="o">=</span> <span class="p">[(</span><span class="n">month0</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="n">cm</span><span class="p">))</span> <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">resp</span><span class="o">.</span><span class="n">cmbirth</span><span class="p">]</span>
<span class="n">resp</span><span class="p">[</span><span class="s1">&#39;decade&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span><span class="o">.</span><span class="n">year</span> <span class="o">-</span> <span class="mi">1900</span><span class="p">)</span> <span class="o">//</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_labels_by_decade</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Draws fake points in order to add labels to the legend.</span>

<span class="sd">    groups: GroupBy object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">thinkplot</span><span class="o">.</span><span class="n">pre_plot</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">0s&#39;</span> <span class="o">%</span> <span class="n">name</span>
        <span class="n">thinkplot</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">15</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">estimate_marriage_survival_by_decade</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Groups respondents by decade and plots survival curves.</span>

<span class="sd">    groups: GroupBy object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">thinkplot</span><span class="o">.</span><span class="n">pre_plot</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">sf</span> <span class="o">=</span> <span class="n">estimate_marriage_survival</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
        <span class="n">thinkplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sf</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_resampled_by_decade</span><span class="p">(</span><span class="n">resps</span><span class="p">,</span> <span class="n">iters</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">predict_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">omit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plots survival curves for resampled data.</span>

<span class="sd">    resps: list of DataFrames</span>
<span class="sd">    iters: number of resamples to plot</span>
<span class="sd">    predict_flag: whether to also plot predictions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iters</span><span class="p">):</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="p">[</span><span class="n">thinkstats2</span><span class="o">.</span><span class="n">resample_rows_weighted</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span> <span class="k">for</span> <span class="n">resp</span> <span class="ow">in</span> <span class="n">resps</span><span class="p">]</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">sample</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;decade&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">omit</span><span class="p">:</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="p">[(</span><span class="n">name</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span>
                <span class="n">omit</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">add_labels_by_decade</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">predict_flag</span><span class="p">:</span>
            <span class="n">plot_predictions_by_decade</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">estimate_marriage_survival_by_decade</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">estimate_marriage_survival_by_decade</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">cmbirth</span></code> is encoded as the integer number of months since December
1899; <code class="docutils literal notranslate"><span class="pre">month0</span></code> represents that date as a Timestamp object. For each
birth date, we instantiate a <code class="docutils literal notranslate"><span class="pre">DateOffset</span></code> that contains the
century-month and add it to <code class="docutils literal notranslate"><span class="pre">month0</span></code>; the result is a sequence of
Timestamps, which is converted to a <code class="docutils literal notranslate"><span class="pre">DateTimeIndex</span></code>. Finally, we extract
<code class="docutils literal notranslate"><span class="pre">year</span></code> and compute decades.</p>
<p>To take into account the sampling weights, and also to show variability
due to sampling error, I resample the data, group respondents by decade,
and plot survival curves:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_resampled_by_decade</span><span class="p">(</span><span class="n">resps</span><span class="p">)</span>
<span class="n">thinkplot</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Age (years)&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Prob unmarried&#39;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="mi">13</span><span class="p">,</span> 
    <span class="mi">45</span><span class="p">],</span> <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>Data from the three NSFG cycles use different sampling weights, so I
resample them separately and then use <code class="docutils literal notranslate"><span class="pre">concat</span></code> to merge them into a
single DataFrame. The parameter <code class="docutils literal notranslate"><span class="pre">ignore_index</span></code> tells <code class="docutils literal notranslate"><span class="pre">concat</span></code> not to
match up respondents by index; instead it creates a new index from 0 to
30768.</p>
<p><code class="docutils literal notranslate"><span class="pre">EstimateSurvivalByDecade</span></code> plots survival curves for each cohort:</p>
<p>Figure <a class="reference internal" href="#survival4"><span class="xref myst">[survival4]</span></a>{reference-type=“ref”
reference=“survival4”} shows the results. Several patterns are visible:</p>
<ul class="simple">
<li><p>Women born in the 50s married earliest, with successive cohorts
marrying later and later, at least until age 30 or so.</p></li>
<li><p>Women born in the 60s follow a surprising pattern. Prior to age 25,
they were marrying at slower rates than their predecessors. After
age 25, they were marrying faster. By age 32 they had overtaken the
50s cohort, and at age 44 they are substantially more likely to have
married.</p></li>
</ul>
<p>Women born in the 60s turned 25 between 1985 and 1995. Remembering
that the <em>Newsweek</em> article I mentioned was published in 1986, it is
tempting to imagine that the article triggered a marriage boom. That
explanation would be too pat, but it is possible that the article
and the reaction to it were indicative of a mood that affected the
behavior of this cohort.</p>
<ul class="simple">
<li><p>The pattern of the 70s cohort is similar. They are less likely than
their predecessors to be married before age 25, but at age 35 they
have caught up with both of the previous cohorts.</p></li>
<li><p>Women born in the 80s are even less likely to marry before age 25.
What happens after that is not clear; for more data, we have to wait
for the next cycle of the NSFG.</p></li>
</ul>
<p>In the meantime we can make some predictions.</p>
</section>
<section id="extrapolation">
<h2>Extrapolation<a class="headerlink" href="#extrapolation" title="Link to this heading">#</a></h2>
<p>The survival curve for the 70s cohort ends at about age 38; for the 80s
cohort it ends at age 28, and for the 90s cohort we hardly have any data
at all.</p>
<p>We can extrapolate these curves by “borrowing” data from the previous
cohort. HazardFunction provides a method, <code class="docutils literal notranslate"><span class="pre">Extend</span></code>, that copies the tail
from another longer HazardFunction:</p>
<p>As we saw in Section <a class="reference internal" href="#hazard"><span class="xref myst">[hazard]</span></a>{reference-type=“ref”
reference=“hazard”}, the HazardFunction contains a Series that maps from
<span class="math notranslate nohighlight">\(t\)</span> to <span class="math notranslate nohighlight">\(\lambda(t)\)</span>. <code class="docutils literal notranslate"><span class="pre">Extend</span></code> finds <code class="docutils literal notranslate"><span class="pre">last</span></code>, which is the last index in
<code class="docutils literal notranslate"><span class="pre">self.series</span></code>, selects values from <code class="docutils literal notranslate"><span class="pre">other</span></code> that come later than <code class="docutils literal notranslate"><span class="pre">last</span></code>,
and appends them onto <code class="docutils literal notranslate"><span class="pre">self.series</span></code>.</p>
<p>Now we can extend the HazardFunction for each cohort, using values from
the predecessor:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_predictions_by_decade</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Groups respondents by decade and plots survival curves.</span>

<span class="sd">    groups: GroupBy object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
        <span class="n">hf</span><span class="p">,</span> <span class="n">sf</span> <span class="o">=</span> <span class="n">estimate_marriage_survival</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
        <span class="n">hfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hf</span><span class="p">)</span>
    <span class="n">thinkplot</span><span class="o">.</span><span class="n">pre_plot</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hfs</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">hf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hfs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">hf</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">hfs</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">sf</span> <span class="o">=</span> <span class="n">hf</span><span class="o">.</span><span class="n">make_survival</span><span class="p">()</span>
        <span class="n">thinkplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sf</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_resampled_by_decade</span><span class="p">(</span><span class="n">resps</span><span class="p">,</span> <span class="n">predict_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">thinkplot</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Age (years)&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Prob unmarried&#39;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="mi">13</span><span class="p">,</span> 
    <span class="mi">45</span><span class="p">],</span> <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">groups</span></code> is a GroupBy object with respondents grouped by decade of
birth. The first loop computes the HazardFunction for each group.</p>
<p>The second loop extends each HazardFunction with values from its
predecessor, which might contain values from the previous group, and so
on. Then it converts each HazardFunction to a SurvivalFunction and plots
it.</p>
<p>Figure <a class="reference internal" href="#survival5"><span class="xref myst">[survival5]</span></a>{reference-type=“ref”
reference=“survival5”} shows the results; I’ve removed the 50s cohort to
make the predictions more visible. These results suggest that by age 40,
the most recent cohorts will converge with the 60s cohort, with fewer
than 20% never married.</p>
</section>
<section id="expected-remaining-lifetime">
<h2>Expected remaining lifetime<a class="headerlink" href="#expected-remaining-lifetime" title="Link to this heading">#</a></h2>
<p>Given a survival curve, we can compute the expected remaining lifetime
as a function of current age. For example, given the survival curve of
pregnancy length from
Section <a class="reference internal" href="#survival"><span class="xref myst">[survival]</span></a>{reference-type=“ref”
reference=“survival”}, we can compute the expected time until delivery.</p>
<p>The first step is to extract the PMF of lifetimes. <code class="docutils literal notranslate"><span class="pre">SurvivalFunction</span></code>
provides a method that does that:</p>
<p>Remember that the SurvivalFunction contains the Cdf of lifetimes. The
loop copies the values and probabilities from the Cdf into a Pmf.</p>
<p><code class="docutils literal notranslate"><span class="pre">cutoff</span></code> is the highest probability in the Cdf, which is 1 if the Cdf is
complete, and otherwise less than 1. If the Cdf is incomplete, we plug
in the provided value, <code class="docutils literal notranslate"><span class="pre">filler</span></code>, to cap it off.</p>
<p>The Cdf of pregnancy lengths is complete, so we don’t have to worry
about this detail yet.</p>
<p>The next step is to compute the expected remaining lifetime, where
“expected” means average. <code class="docutils literal notranslate"><span class="pre">SurvivalFunction</span></code> provides a method that does
that, too:</p>
<p><code class="docutils literal notranslate"><span class="pre">RemainingLifetime</span></code> takes <code class="docutils literal notranslate"><span class="pre">filler</span></code>, which is passed along to <code class="docutils literal notranslate"><span class="pre">MakePmf</span></code>,
and <code class="docutils literal notranslate"><span class="pre">func</span></code> which is the function used to summarize the distribution of
remaining lifetimes.</p>
<p><code class="docutils literal notranslate"><span class="pre">pmf</span></code> is the Pmf of lifetimes extracted from the SurvivalFunction. <code class="docutils literal notranslate"><span class="pre">d</span></code>
is a dictionary that contains the results, a map from current age, <code class="docutils literal notranslate"><span class="pre">t</span></code>,
to expected remaining lifetime.</p>
<p>The loop iterates through the values in the Pmf. For each value of <code class="docutils literal notranslate"><span class="pre">t</span></code>
it computes the conditional distribution of lifetimes, given that the
lifetime exceeds <code class="docutils literal notranslate"><span class="pre">t</span></code>. It does that by removing values from the Pmf one
at a time and renormalizing the remaining values.</p>
<p>Then it uses <code class="docutils literal notranslate"><span class="pre">func</span></code> to summarize the conditional distribution. In this
example the result is the mean pregnancy length, given that the length
exceeds <code class="docutils literal notranslate"><span class="pre">t</span></code>. By subtracting <code class="docutils literal notranslate"><span class="pre">t</span></code> we get the mean remaining pregnancy
length.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preg</span> <span class="o">=</span> <span class="n">nsfg</span><span class="o">.</span><span class="n">read_fem_preg</span><span class="p">()</span>
<span class="n">complete</span> <span class="o">=</span> <span class="n">preg</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;outcome in [1, 3, 4]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">prglngth</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of complete pregnancies&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">complete</span><span class="p">))</span>
<span class="n">ongoing</span> <span class="o">=</span> <span class="n">preg</span><span class="p">[</span><span class="n">preg</span><span class="o">.</span><span class="n">outcome</span> <span class="o">==</span> <span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">prglngth</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of ongoing pregnancies&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ongoing</span><span class="p">))</span>
<span class="n">hf</span> <span class="o">=</span> <span class="n">estimate_hazard_function</span><span class="p">(</span><span class="n">complete</span><span class="p">,</span> <span class="n">ongoing</span><span class="p">)</span>
<span class="n">sf1</span> <span class="o">=</span> <span class="n">hf</span><span class="o">.</span><span class="n">make_survival</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rem_life1</span> <span class="o">=</span> <span class="n">sf1</span><span class="o">.</span><span class="n">remaining_lifetime</span><span class="p">()</span>
<span class="n">thinkplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rem_life1</span><span class="p">)</span>
<span class="n">thinkplot</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Remaining pregnancy length&#39;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Weeks&#39;</span><span class="p">,</span> <span class="n">ylabel</span>
    <span class="o">=</span><span class="s1">&#39;Mean remaining weeks&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Figure <a class="reference internal" href="#survival6"><span class="xref myst">[survival6]</span></a>{reference-type=“ref”
reference=“survival6”} (left) shows the expected remaining pregnancy
length as a function of the current duration. For example, during Week
0, the expected remaining duration is about 34 weeks. That’s less than
full term (39 weeks) because terminations of pregnancy in the first
trimester bring the average down.</p>
<p>The curve drops slowly during the first trimester. After 13 weeks, the
expected remaining lifetime has dropped by only 9 weeks, to 25. After
that the curve drops faster, by about a week per week.</p>
<p>Between Week 37 and 42, the curve levels off between 1 and 2 weeks. At
any time during this period, the expected remaining lifetime is the
same; with each week that passes, the destination gets no closer.
Processes with this property are called <strong>memoryless</strong> because the past
has no effect on the predictions. This behavior is the mathematical
basis of the infuriating mantra of obstetrics nurses: “any day now.”</p>
<p>Figure <a class="reference internal" href="#survival6"><span class="xref myst">[survival6]</span></a>{reference-type=“ref”
reference=“survival6”} (right) shows the median remaining time until
first marriage, as a function of age. For an 11 year-old girl, the
median time until first marriage is about 14 years. The curve decreases
until age 22 when the median remaining time is about 7 years. After that
it increases again: by age 30 it is back where it started, at 14 years.</p>
<p>Based on this data, young women have decreasing remaining “lifetimes”.
Mechanical components with this property are called <strong>NBUE</strong> for “new
better than used in expectation,” meaning that a new part is expected to
last longer.</p>
<p>Women older than 22 have increasing remaining time until first marriage.
Components with this property are called <strong>UBNE</strong> for “used better than
new in expectation.” That is, the older the part, the longer it is
expected to last. Newborns and cancer patients are also UBNE; their life
expectancy increases the longer they live.</p>
<p>For this example I computed median, rather than mean, because the Cdf is
incomplete; the survival curve projects that about 20% of respondents
will not marry before age 44. The age of first marriage for these women
is unknown, and might be non-existent, so we can’t compute a mean.</p>
<p>I deal with these unknown values by replacing them with <code class="docutils literal notranslate"><span class="pre">np.inf</span></code>, a
special value that represents infinity. That makes the mean infinity for
all ages, but the median is well-defined as long as more than 50% of the
remaining lifetimes are finite, which is true until age 30. After that
it is hard to define a meaningful expected remaining lifetime.</p>
<p>Here’s the code that computes and plots these functions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hf</span><span class="p">,</span> <span class="n">sf2</span> <span class="o">=</span> <span class="n">estimate_marriage_survival</span><span class="p">(</span><span class="n">resp6</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">pmf</span><span class="p">:</span> <span class="n">pmf</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
<span class="n">rem_life2</span> <span class="o">=</span> <span class="n">sf2</span><span class="o">.</span><span class="n">remaining_lifetime</span><span class="p">(</span><span class="n">filler</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="p">)</span>
<span class="n">thinkplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rem_life2</span><span class="p">)</span>
<span class="n">thinkplot</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Years until first marriage&#39;</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">],</span> <span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="mi">11</span><span class="p">,</span>
    <span class="mi">31</span><span class="p">],</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Age (years)&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Median remaining years&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">sf1</span></code> is the survival curve for pregnancy length; in this case we can
use the default values for <code class="docutils literal notranslate"><span class="pre">RemainingLifetime</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">sf2</span></code> is the survival curve for age at first marriage; <code class="docutils literal notranslate"><span class="pre">func</span></code> is a
function that takes a Pmf and computes its median (50th percentile).</p>
</section>
<section id="glossary">
<h2>Glossary<a class="headerlink" href="#glossary" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>survival analysis</strong>: A set of methods for describing and
predicting lifetimes, or more generally time until an event occurs.</p></li>
<li><p><strong>survival curve</strong>: A function that maps from a time, <span class="math notranslate nohighlight">\(t\)</span>, to the
probability of surviving past <span class="math notranslate nohighlight">\(t\)</span>.</p></li>
<li><p><strong>hazard function</strong>: A function that maps from <span class="math notranslate nohighlight">\(t\)</span> to the fraction
of people alive until <span class="math notranslate nohighlight">\(t\)</span> who die at <span class="math notranslate nohighlight">\(t\)</span>.</p></li>
<li><p><strong>Kaplan-Meier estimation</strong>: An algorithm for estimating hazard and
survival functions.</p></li>
<li><p><strong>cohort</strong>: a group of subjects defined by an event, like date of
birth, in a particular interval of time.</p></li>
<li><p><strong>cohort effect</strong>: a difference between cohorts.</p></li>
<li><p><strong>NBUE</strong>: A property of expected remaining lifetime, “New better
than used in expectation.”</p></li>
<li><p><strong>UBNE</strong>: A property of expected remaining lifetime, “Used better
than new in expectation.”</p></li>
</ul>
</section>
<section id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Link to this heading">#</a></h2>
<p><strong>Exercise:</strong>    In NSFG Cycles 6 and 7, the variable <code class="docutils literal notranslate"><span class="pre">cmdivorcx</span></code> contains the date of divorce for the respondent’s first marriage, if applicable, encoded in century-months.</p>
<p>Compute the duration of marriages that have ended in divorce, and the duration, so far, of marriages that are ongoing. Estimate the hazard and survival curve for the duration of marriage.</p>
<p>Use resampling to take into account sampling weights, and plot data from several resamples to visualize sampling error.</p>
<p>Consider dividing the respondents into groups by decade of birth, and possibly by age at first marriage.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">clean_data</span><span class="p">(</span><span class="n">resp</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cleans respondent data.</span>

<span class="sd">    resp: DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;cmdivorcx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">cmdivorcx</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="mi">9998</span><span class="p">,</span> <span class="mi">9999</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;notdivorced&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">cmdivorcx</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">cmdivorcx</span> <span class="o">-</span> <span class="n">resp</span><span class="o">.</span><span class="n">cmmarrhx</span><span class="p">)</span> <span class="o">/</span> <span class="mf">12.0</span>
    <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;durationsofar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">cmintvw</span> <span class="o">-</span> <span class="n">resp</span><span class="o">.</span><span class="n">cmmarrhx</span><span class="p">)</span> <span class="o">/</span> <span class="mf">12.0</span>
    <span class="n">month0</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s1">&#39;1899-12-15&#39;</span><span class="p">)</span>
    <span class="n">dates</span> <span class="o">=</span> <span class="p">[(</span><span class="n">month0</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="n">cm</span><span class="p">))</span> <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">resp</span><span class="o">.</span><span class="n">cmbirth</span><span class="p">]</span>
    <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;decade&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span><span class="o">.</span><span class="n">year</span> <span class="o">-</span> <span class="mi">1900</span><span class="p">)</span> <span class="o">//</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clean_data</span><span class="p">(</span><span class="n">resp6</span><span class="p">)</span>
<span class="n">married6</span> <span class="o">=</span> <span class="n">resp6</span><span class="p">[</span><span class="n">resp6</span><span class="o">.</span><span class="n">evrmarry</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">clean_data</span><span class="p">(</span><span class="n">resp7</span><span class="p">)</span>
<span class="n">married7</span> <span class="o">=</span> <span class="n">resp7</span><span class="p">[</span><span class="n">resp7</span><span class="o">.</span><span class="n">evrmarry</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">thinkstats2</span> <span class="kn">import</span> <span class="n">add_labels_by_decade</span>


<span class="k">def</span> <span class="nf">resample_divorce_curve_by_decade</span><span class="p">(</span><span class="n">resps</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plots divorce curves for each birth cohort.</span>

<span class="sd">    resps: list of respondent DataFrames</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">41</span><span class="p">):</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="p">[</span><span class="n">thinkstats2</span><span class="o">.</span><span class="n">resample_rows_weighted</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span> <span class="k">for</span> <span class="n">resp</span> <span class="ow">in</span> <span class="n">resps</span><span class="p">]</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">sample</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;decade&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">add_labels_by_decade</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="n">estimate_survival_by_decade</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">thinkplot</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Years&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Fraction undivorced&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span>
        <span class="mi">28</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">estimate_survival_by_decade</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Groups respondents by decade and plots survival curves.</span>

<span class="sd">    groups: GroupBy object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">thinkplot</span><span class="o">.</span><span class="n">pre_plot</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">sf</span> <span class="o">=</span> <span class="n">estimate_survival</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
        <span class="n">thinkplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sf</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">estimate_survival</span><span class="p">(</span><span class="n">resp</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Estimates the survival curve.</span>

<span class="sd">    resp: DataFrame of respondents</span>

<span class="sd">    returns: pair of HazardFunction, SurvivalFunction</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">complete</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="n">resp</span><span class="o">.</span><span class="n">notdivorced</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">duration</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="n">ongoing</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="n">resp</span><span class="o">.</span><span class="n">notdivorced</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">durationsofar</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="n">hf</span> <span class="o">=</span> <span class="n">estimate_hazard_function</span><span class="p">(</span><span class="n">complete</span><span class="p">,</span> <span class="n">ongoing</span><span class="p">)</span>
    <span class="n">sf</span> <span class="o">=</span> <span class="n">hf</span><span class="o">.</span><span class="n">make_survival</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">hf</span><span class="p">,</span> <span class="n">sf</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">resample_divorce_curve_by_decade</span><span class="p">([</span><span class="n">married6</span><span class="p">,</span> <span class="n">married7</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="chap12.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Time series analysis</p>
      </div>
    </a>
    <a class="right-next"
       href="chap14.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Analytic methods</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#survival-curves">Survival curves</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#hazard-function">Hazard function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#inferring-survival-curves">Inferring survival curves</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#kaplan-meier-estimation">Kaplan-Meier estimation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-marriage-curve">The marriage curve</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#estimating-the-survival-curve">Estimating the survival curve</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#confidence-intervals">Confidence intervals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cohort-effects">Cohort effects</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extrapolation">Extrapolation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#expected-remaining-lifetime">Expected remaining lifetime</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#glossary">Glossary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Allen B. Downey
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>