
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>14. Survival analysis &#8212; Think Stats, 3rd edition</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=87e54e7c" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=3ee479438cf8b5e0d341"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=36754332"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]]}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'chap13';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="15. Analytic methods" href="chap14.html" />
    <link rel="prev" title="13. Time series analysis" href="chap12.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
  
    <p class="title logo__title">Think Stats, 3rd edition</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    Think Stats, 3rd edition
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Front Matter</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="chap00.html">Preface</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Chapters</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="chap01.html">1. Exploratory data analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap02.html">2. Distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap03.html">3. Probability Mass Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap04.html">4. Cumulative Distribution Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap05.html">5. Modeling Distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap06.html">6. Probability Density Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap07.html">7. Relationships between variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap08.html">8. Estimation</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap09.html">9. Hypothesis Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap10.html">10. Least Squares</a></li>

<li class="toctree-l1"><a class="reference internal" href="chap11.html">12. Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap12.html">13. Time series analysis</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">14. Survival analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap14.html">15. Analytic methods</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ripoff_etf.html">Rip-off ETF?</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/AllenDowney/ThinkStats/tree/v3" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/chap13.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Survival analysis</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#survival-curves">14.1. Survival curves</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#hazard-function">14.2. Hazard function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#inferring-survival-curves">14.3. Inferring survival curves</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#kaplan-meier-estimation">14.4. Kaplan-Meier estimation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-marriage-curve">14.5. The marriage curve</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#estimating-the-survival-curve">14.6. Estimating the survival curve</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#confidence-intervals">14.7. Confidence intervals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cohort-effects">14.8. Cohort effects</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extrapolation">14.9. Extrapolation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#expected-remaining-lifetime">14.10. Expected remaining lifetime</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#glossary">14.11. Glossary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">14.12. Exercises</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="survival-analysis">
<h1><span class="section-number">14. </span>Survival analysis<a class="headerlink" href="#survival-analysis" title="Link to this heading">#</a></h1>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">basename</span><span class="p">,</span> <span class="n">exists</span>


<span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlretrieve</span>

        <span class="n">local</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloaded &quot;</span> <span class="o">+</span> <span class="n">local</span><span class="p">)</span>


<span class="n">download</span><span class="p">(</span><span class="s2">&quot;https://github.com/AllenDowney/ThinkStats/raw/v3/nb/thinkstats.py&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 2;
                var nbb_unformatted_code = "from os.path import basename, exists\n\n\ndef download(url):\n    filename = basename(url)\n    if not exists(filename):\n        from urllib.request import urlretrieve\n\n        local, _ = urlretrieve(url, filename)\n        print(\"Downloaded \" + local)\n\n\ndownload(\"https://github.com/AllenDowney/ThinkStats/raw/v3/nb/thinkstats.py\")";
                var nbb_formatted_code = "from os.path import basename, exists\n\n\ndef download(url):\n    filename = basename(url)\n    if not exists(filename):\n        from urllib.request import urlretrieve\n\n        local, _ = urlretrieve(url, filename)\n        print(\"Downloaded \" + local)\n\n\ndownload(\"https://github.com/AllenDowney/ThinkStats/raw/v3/nb/thinkstats.py\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">thinkstats</span> <span class="kn">import</span> <span class="n">decorate</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 3;
                var nbb_unformatted_code = "import numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\n\nfrom thinkstats import decorate";
                var nbb_formatted_code = "import numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\n\nfrom thinkstats import decorate";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p><strong>Survival analysis</strong> is a way to describe how long things last.
It is often used to study human lifetimes, but it also applies to “survival” of mechanical and electronic components, or more generally to intervals in time before an event.</p>
<p>If someone you know has been diagnosed with a life-threatening disease, you might have seen a “5-year survival rate,” which is the probability of surviving five years after diagnosis.
That estimate and related statistics are the result of survival analysis.</p>
<section id="survival-curves">
<h2><span class="section-number">14.1. </span>Survival curves<a class="headerlink" href="#survival-curves" title="Link to this heading">#</a></h2>
<p>The fundamental concept in survival analysis is the <strong>survival curve</strong>, <span class="math notranslate nohighlight">\(S(t)\)</span>, which is a function that maps from a duration, <span class="math notranslate nohighlight">\(t\)</span>, to the probability of surviving longer than <span class="math notranslate nohighlight">\(t\)</span>.
If you know the distribution of durations, or “lifetimes”, finding the survival curve is easy; it’s just the complement of the CDF:</p>
<div class="math notranslate nohighlight">
\[S(t) = 1 - CDF(t)\]</div>
<p>where <span class="math notranslate nohighlight">\(CDF(t)\)</span> is the probability of a lifetime less than or equal to <span class="math notranslate nohighlight">\(t\)</span>.</p>
<p>For example, in the NSFG dataset, we know the duration of 11,189 complete pregnancies.
We can read this data and compute the CDF:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">download</span><span class="p">(</span><span class="s2">&quot;https://github.com/AllenDowney/ThinkStats/raw/v3/nb/nsfg.py&quot;</span><span class="p">)</span>
<span class="n">download</span><span class="p">(</span><span class="s2">&quot;https://github.com/AllenDowney/ThinkStats/raw/v3/data/2002FemPreg.dct&quot;</span><span class="p">)</span>
<span class="n">download</span><span class="p">(</span><span class="s2">&quot;https://github.com/AllenDowney/ThinkStats/raw/v3/data/2002FemPreg.dat.gz&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 4;
                var nbb_unformatted_code = "download(\"https://github.com/AllenDowney/ThinkStats/raw/v3/nb/nsfg.py\")\ndownload(\"https://github.com/AllenDowney/ThinkStats/raw/v3/data/2002FemPreg.dct\")\ndownload(\"https://github.com/AllenDowney/ThinkStats/raw/v3/data/2002FemPreg.dat.gz\")";
                var nbb_formatted_code = "download(\"https://github.com/AllenDowney/ThinkStats/raw/v3/nb/nsfg.py\")\ndownload(\"https://github.com/AllenDowney/ThinkStats/raw/v3/data/2002FemPreg.dct\")\ndownload(\"https://github.com/AllenDowney/ThinkStats/raw/v3/data/2002FemPreg.dat.gz\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">nsfg</span>

<span class="n">preg</span> <span class="o">=</span> <span class="n">nsfg</span><span class="o">.</span><span class="n">read_fem_preg</span><span class="p">()</span>
<span class="n">preg</span><span class="o">.</span><span class="n">prglngth</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>13593
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 5;
                var nbb_unformatted_code = "import nsfg\n\npreg = nsfg.read_fem_preg()\npreg.prglngth.count()";
                var nbb_formatted_code = "import nsfg\n\npreg = nsfg.read_fem_preg()\npreg.prglngth.count()";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">complete</span> <span class="o">=</span> <span class="n">preg</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;outcome in [1, 3, 4]&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">prglngth</span>
<span class="n">complete</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>11189
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 6;
                var nbb_unformatted_code = "complete = preg.query(\"outcome in [1, 3, 4]\").prglngth\ncomplete.count()";
                var nbb_formatted_code = "complete = preg.query(\"outcome in [1, 3, 4]\").prglngth\ncomplete.count()";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">empiricaldist</span> <span class="kn">import</span> <span class="n">Cdf</span>

<span class="n">cdf</span> <span class="o">=</span> <span class="n">Cdf</span><span class="o">.</span><span class="n">from_seq</span><span class="p">(</span><span class="n">complete</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cdf&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 7;
                var nbb_unformatted_code = "from empiricaldist import Cdf\n\ncdf = Cdf.from_seq(complete, name=\"cdf\")";
                var nbb_formatted_code = "from empiricaldist import Cdf\n\ncdf = Cdf.from_seq(complete, name=\"cdf\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The outcome codes <code class="docutils literal notranslate"><span class="pre">1,</span> <span class="pre">3,</span> <span class="pre">4</span></code> indicate live birth, stillbirth, and miscarriage.
For this analysis I am excluding induced abortions, ectopic pregnancies, and pregnancies that were in progress when the respondent was interviewed.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> method <code class="docutils literal notranslate"><span class="pre">query</span></code> takes a boolean expression and evaluates it for each row, selecting the rows that yield True.</p>
<p><code class="docutils literal notranslate"><span class="pre">SurvivalFunction</span></code> provides two properties: <code class="docutils literal notranslate"><span class="pre">ts</span></code>, which is the sequence of lifetimes, and <code class="docutils literal notranslate"><span class="pre">ss</span></code>, which is the survival curve.
In Python, a “property” is a method that can be invoked as if it were a variable.</p>
<p>We can instantiate a <code class="docutils literal notranslate"><span class="pre">SurvivalFunction</span></code> by passing the CDF of lifetimes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">empiricaldist</span> <span class="kn">import</span> <span class="n">Surv</span>


<span class="k">def</span> <span class="nf">make_surv_from_cdf</span><span class="p">(</span><span class="n">cdf</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Makes a survival function based on a CDF.</span>

<span class="sd">    cdf: Cdf</span>

<span class="sd">    returns: SurvivalFunction</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">cdf</span><span class="o">.</span><span class="n">qs</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">cdf</span><span class="o">.</span><span class="n">ps</span>
    <span class="k">return</span> <span class="n">Surv</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 8;
                var nbb_unformatted_code = "from empiricaldist import Surv\n\n\ndef make_surv_from_cdf(cdf, name=\"\"):\n    \"\"\"Makes a survival function based on a CDF.\n\n    cdf: Cdf\n\n    returns: SurvivalFunction\n    \"\"\"\n    ts = cdf.qs\n    ss = 1 - cdf.ps\n    return Surv(ss, ts, name=name)";
                var nbb_formatted_code = "from empiricaldist import Surv\n\n\ndef make_surv_from_cdf(cdf, name=\"\"):\n    \"\"\"Makes a survival function based on a CDF.\n\n    cdf: Cdf\n\n    returns: SurvivalFunction\n    \"\"\"\n    ts = cdf.qs\n    ss = 1 - cdf.ps\n    return Surv(ss, ts, name=name)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sf</span> <span class="o">=</span> <span class="n">make_surv_from_cdf</span><span class="p">(</span><span class="n">cdf</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;survival&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 9;
                var nbb_unformatted_code = "sf = make_surv_from_cdf(cdf, name=\"survival\")";
                var nbb_formatted_code = "sf = make_surv_from_cdf(cdf, name=\"survival\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">SurvivalFunction</span></code> also provides <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code> and <code class="docutils literal notranslate"><span class="pre">Prob</span></code>, which evaluates the survival curve:</p>
<p>For example, <code class="docutils literal notranslate"><span class="pre">sf[13]</span></code> is the fraction of pregnancies that proceed past the first trimester:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sf</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array(0.86021986)
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 10;
                var nbb_unformatted_code = "sf(13)";
                var nbb_formatted_code = "sf(13)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cdf</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array(0.13978014)
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 11;
                var nbb_unformatted_code = "cdf(13)";
                var nbb_formatted_code = "cdf(13)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>About 86% of pregnancies proceed past the first trimester; about 14% do not.</p>
<p>The following figure shows the CDF of pregnancy length and its complement, the survival curve.
To represent the survival curve, I define an object that wraps a <code class="docutils literal notranslate"><span class="pre">Cdf</span></code> and adapts the interface:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sf</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">cdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Duration (weeks)&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Probability&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/3646969e95f30dd68b5c216a9a736a4ec7b03323bd8188a6ccaa9ff57b6afb48.png" src="_images/3646969e95f30dd68b5c216a9a736a4ec7b03323bd8188a6ccaa9ff57b6afb48.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 12;
                var nbb_unformatted_code = "sf.plot()\ncdf.plot(alpha=0.4)\ndecorate(xlabel=\"Duration (weeks)\", ylabel=\"Probability\")";
                var nbb_formatted_code = "sf.plot()\ncdf.plot(alpha=0.4)\ndecorate(xlabel=\"Duration (weeks)\", ylabel=\"Probability\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The curve is nearly flat between 13 and 26 weeks, which shows that few pregnancies end in the second trimester.
And the curve is steepest around 39 weeks, which is the most common pregnancy length.</p>
</section>
<section id="hazard-function">
<h2><span class="section-number">14.2. </span>Hazard function<a class="headerlink" href="#hazard-function" title="Link to this heading">#</a></h2>
<p>From the survival curve we can derive the <strong>hazard function</strong>; for pregnancy lengths, the hazard function maps from a time, <span class="math notranslate nohighlight">\(t\)</span>, to the fraction of pregnancies that continue until <span class="math notranslate nohighlight">\(t\)</span> and then end at <span class="math notranslate nohighlight">\(t\)</span>.
To be more precise:</p>
<div class="math notranslate nohighlight">
\[\lambda(t) = \frac{S(t) - S(t+1)}{S(t)}\]</div>
<p>The numerator is the fraction of lifetimes that end at <span class="math notranslate nohighlight">\(t\)</span>, which is also <span class="math notranslate nohighlight">\(PMF(t)\)</span>.</p>
<p><code class="docutils literal notranslate"><span class="pre">SurvivalFunction</span></code> provides <code class="docutils literal notranslate"><span class="pre">make_hazard_function</span></code>, which calculates the hazard function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hf</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">make_hazard</span><span class="p">()</span>
<span class="n">hf</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;hazard&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 13;
                var nbb_unformatted_code = "hf = sf.make_hazard()\nhf.name = \"hazard\"";
                var nbb_formatted_code = "hf = sf.make_hazard()\nhf.name = \"hazard\"";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The result is a <code class="docutils literal notranslate"><span class="pre">Hazard</span></code> object, whichwe can evaluate it like this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hf</span><span class="p">[</span><span class="mi">39</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.6767068273092369
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 14;
                var nbb_unformatted_code = "hf[39]";
                var nbb_formatted_code = "hf[39]";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>So of all pregnancies that proceed until week 39, about 50% end in week 39.</p>
<p>The following figure shows the hazard function for pregnancy lengths.
For times after week 42, the hazard function is erratic because it is based on a small number of cases.
Other than that the shape of the curve is as expected: it is highest around 39 weeks, and a little higher in the first trimester than in the second.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hf</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Duration (weeks)&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Hazard rate&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/d26a0d9172fbc7fb954d28cc395775a549784abc67b9c7c6ae9ef57fc29e125e.png" src="_images/d26a0d9172fbc7fb954d28cc395775a549784abc67b9c7c6ae9ef57fc29e125e.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 15;
                var nbb_unformatted_code = "hf.plot()\ndecorate(xlabel=\"Duration (weeks)\", ylabel=\"Hazard rate\")";
                var nbb_formatted_code = "hf.plot()\ndecorate(xlabel=\"Duration (weeks)\", ylabel=\"Hazard rate\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The hazard function is useful in its own right, but it is also an important tool for estimating survival curves, as we’ll see in the next section.</p>
</section>
<section id="inferring-survival-curves">
<h2><span class="section-number">14.3. </span>Inferring survival curves<a class="headerlink" href="#inferring-survival-curves" title="Link to this heading">#</a></h2>
<p>If someone gives you the CDF of lifetimes, it is easy to compute the survival and hazard functions.
But in many real-world scenarios, we can’t measure the distribution of lifetimes directly.
We have to infer it.</p>
<p>For example, suppose you are following a group of patients to see how long they survive after diagnosis.
Not all patients are diagnosed on the same day, so at any point in time, some patients have survived longer than others.
If some patients have died, we know their survival times.
For patients who are still alive, we don’t know survival times, but we have a lower bound.</p>
<p>If we wait until all patients are dead, we can compute the survival curve, but if we are evaluating the effectiveness of a new treatment, we can’t wait that long! We need a way to estimate survival curves using incomplete information.</p>
<p>As a more cheerful example, I will use NSFG data to quantify how long respondents “survive” until they get married for the first time.
The range of respondents’ ages is 14 to 44 years, so the dataset provides a snapshot of women at different stages in their lives.</p>
<p>For women who have been married, the dataset includes the date of their first marriage and their age at the time.
For women who have not been married, we know their age when interviewed, but have no way of knowing when or if they will get married.</p>
<p>Since we know the age at first marriage for <em>some</em> women, it might be tempting to exclude the rest and compute the CDF of the known data.
That is a bad idea.
The result would be doubly misleading: (1) older women would be overrepresented, because they are more likely to be married when interviewed, and (2) married women would be overrepresented! In fact, this analysis would lead to the conclusion that all women get married, which is obviously incorrect.</p>
</section>
<section id="kaplan-meier-estimation">
<h2><span class="section-number">14.4. </span>Kaplan-Meier estimation<a class="headerlink" href="#kaplan-meier-estimation" title="Link to this heading">#</a></h2>
<p>In this example it is not only desirable but necessary to include observations of unmarried women, which brings us to one of the central algorithms in survival analysis, <strong>Kaplan-Meier estimation</strong>.</p>
<p>The general idea is that we can use the data to estimate the hazard function, then convert the hazard function to a survival curve.
To estimate the hazard function, we consider, for each age, (1) the number of women who got married at that age and (2) the number of women “at risk” of getting married, which includes all women who were not married at an earlier age.</p>
<p>Here’s the code:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">empiricaldist</span> <span class="kn">import</span> <span class="n">Hazard</span>


<span class="k">def</span> <span class="nf">estimate_hazard_function</span><span class="p">(</span><span class="n">complete</span><span class="p">,</span> <span class="n">ongoing</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Estimates the hazard function by Kaplan-Meier.</span>

<span class="sd">    http://en.wikipedia.org/wiki/Kaplan%E2%80%93Meier_estimator</span>

<span class="sd">    complete: list of complete lifetimes</span>
<span class="sd">    ongoing: list of ongoing lifetimes</span>
<span class="sd">    label: string</span>
<span class="sd">    verbose: whether to display intermediate results</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">complete</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;complete contains NaNs&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ongoing</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ongoing contains NaNs&quot;</span><span class="p">)</span>

    <span class="n">hist_complete</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">complete</span><span class="p">)</span>
    <span class="n">hist_ongoing</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">ongoing</span><span class="p">)</span>

    <span class="n">ts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hist_complete</span> <span class="o">|</span> <span class="n">hist_ongoing</span><span class="p">)</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">at_risk</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">complete</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">ongoing</span><span class="p">)</span>

    <span class="n">lams</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">ts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ts</span><span class="p">:</span>
        <span class="n">ended</span> <span class="o">=</span> <span class="n">hist_complete</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
        <span class="n">censored</span> <span class="o">=</span> <span class="n">hist_ongoing</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
        <span class="n">lams</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">ended</span> <span class="o">/</span> <span class="n">at_risk</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">at_risk</span><span class="p">,</span> <span class="n">ended</span><span class="p">,</span> <span class="n">censored</span><span class="p">,</span> <span class="n">lams</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
        <span class="n">at_risk</span> <span class="o">-=</span> <span class="n">ended</span> <span class="o">+</span> <span class="n">censored</span>

    <span class="k">return</span> <span class="n">Hazard</span><span class="p">(</span><span class="n">lams</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 16;
                var nbb_unformatted_code = "import pandas as pd\nfrom collections import Counter\nfrom empiricaldist import Hazard\n\n\ndef estimate_hazard_function(complete, ongoing, name=\"\", verbose=False):\n    \"\"\"Estimates the hazard function by Kaplan-Meier.\n\n    http://en.wikipedia.org/wiki/Kaplan%E2%80%93Meier_estimator\n\n    complete: list of complete lifetimes\n    ongoing: list of ongoing lifetimes\n    label: string\n    verbose: whether to display intermediate results\n    \"\"\"\n    if np.sum(np.isnan(complete)):\n        raise ValueError(\"complete contains NaNs\")\n    if np.sum(np.isnan(ongoing)):\n        raise ValueError(\"ongoing contains NaNs\")\n\n    hist_complete = Counter(complete)\n    hist_ongoing = Counter(ongoing)\n\n    ts = list(hist_complete | hist_ongoing)\n    ts.sort()\n    at_risk = len(complete) + len(ongoing)\n\n    lams = pd.Series(index=ts, dtype=float)\n    for t in ts:\n        ended = hist_complete[t]\n        censored = hist_ongoing[t]\n        lams[t] = ended / at_risk\n        if verbose:\n            print(t, at_risk, ended, censored, lams[t])\n        at_risk -= ended + censored\n\n    return Hazard(lams, ts)";
                var nbb_formatted_code = "import pandas as pd\nfrom collections import Counter\nfrom empiricaldist import Hazard\n\n\ndef estimate_hazard_function(complete, ongoing, name=\"\", verbose=False):\n    \"\"\"Estimates the hazard function by Kaplan-Meier.\n\n    http://en.wikipedia.org/wiki/Kaplan%E2%80%93Meier_estimator\n\n    complete: list of complete lifetimes\n    ongoing: list of ongoing lifetimes\n    label: string\n    verbose: whether to display intermediate results\n    \"\"\"\n    if np.sum(np.isnan(complete)):\n        raise ValueError(\"complete contains NaNs\")\n    if np.sum(np.isnan(ongoing)):\n        raise ValueError(\"ongoing contains NaNs\")\n\n    hist_complete = Counter(complete)\n    hist_ongoing = Counter(ongoing)\n\n    ts = list(hist_complete | hist_ongoing)\n    ts.sort()\n    at_risk = len(complete) + len(ongoing)\n\n    lams = pd.Series(index=ts, dtype=float)\n    for t in ts:\n        ended = hist_complete[t]\n        censored = hist_ongoing[t]\n        lams[t] = ended / at_risk\n        if verbose:\n            print(t, at_risk, ended, censored, lams[t])\n        at_risk -= ended + censored\n\n    return Hazard(lams, ts)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">complete</span></code> is the set of complete observations; in this case, the ages when respondents got married.
<code class="docutils literal notranslate"><span class="pre">ongoing</span></code> is the set of incomplete observations; that is, the ages of unmarried women when they were interviewed.</p>
<p>First, we precompute <code class="docutils literal notranslate"><span class="pre">hist_complete</span></code>, which is a Counter that maps from each age to the number of women married at that age, and <code class="docutils literal notranslate"><span class="pre">hist_ongoing</span></code> which maps from each age to the number of unmarried women interviewed at that age.</p>
<p><code class="docutils literal notranslate"><span class="pre">ts</span></code> is the union of ages when respondents got married and ages when unmarried women were interviewed, sorted in increasing order.</p>
<p><code class="docutils literal notranslate"><span class="pre">at_risk</span></code> keeps track of the number of respondents considered “at risk” at each age; initially, it is the total number of respondents.</p>
<p>The result is stored in a Pandas <code class="docutils literal notranslate"><span class="pre">Series</span></code> that maps from each age to the estimated hazard function at that age.</p>
<p>Each time through the loop, we consider one age, <code class="docutils literal notranslate"><span class="pre">t</span></code>, and compute the number of events that end at <code class="docutils literal notranslate"><span class="pre">t</span></code> (that is, the number of respondents married at that age) and the number of events censored at <code class="docutils literal notranslate"><span class="pre">t</span></code> (that is, the number of women interviewed at <code class="docutils literal notranslate"><span class="pre">t</span></code> whose future marriage dates are censored).
In this context, “censored” means that the data are unavailable because of the data collection process.</p>
<p>The estimated hazard function is the fraction of the cases at risk that end at <code class="docutils literal notranslate"><span class="pre">t</span></code>.</p>
<p>At the end of the loop, we subtract from <code class="docutils literal notranslate"><span class="pre">at_risk</span></code> the number of cases that ended or were censored at <code class="docutils literal notranslate"><span class="pre">t</span></code>.</p>
<p>Finally, we pass <code class="docutils literal notranslate"><span class="pre">lams</span></code> to the <code class="docutils literal notranslate"><span class="pre">Hazard</span></code> constructor and return the result.</p>
</section>
<section id="the-marriage-curve">
<h2><span class="section-number">14.5. </span>The marriage curve<a class="headerlink" href="#the-marriage-curve" title="Link to this heading">#</a></h2>
<p>To test this function, we have to do some data cleaning and transformation.
The NSFG variables we need are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">cmbirth</span></code>: The respondent’s date of birth, known for all respondents.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cmintvw</span></code>: The date the respondent was interviewed, known for all respondents.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cmmarrhx</span></code>: The date the respondent was first married, if applicable and known.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">evrmarry</span></code>: 1 if the respondent had been married prior to the date of interview, 0 otherwise.</p></li>
</ul>
<p>The first three variables are encoded in “century-months”; that is, the integer number of months since December 1899.
So century-month 1 is January 1900.</p>
<p>First, we read the respondent file and replace invalid values of <code class="docutils literal notranslate"><span class="pre">cmmarrhx</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">nsfg</span>

<span class="n">resp</span> <span class="o">=</span> <span class="n">nsfg</span><span class="o">.</span><span class="n">read_fem_resp</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 17;
                var nbb_unformatted_code = "import nsfg\n\nresp = nsfg.read_fem_resp()";
                var nbb_formatted_code = "import nsfg\n\nresp = nsfg.read_fem_resp()";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">resp</span><span class="p">[</span><span class="s2">&quot;cmmarrhx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">cmmarrhx</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="mi">9997</span><span class="p">,</span> <span class="mi">9998</span><span class="p">,</span> <span class="mi">9999</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 18;
                var nbb_unformatted_code = "resp[\"cmmarrhx\"] = resp.cmmarrhx.replace([9997, 9998, 9999], np.nan)";
                var nbb_formatted_code = "resp[\"cmmarrhx\"] = resp.cmmarrhx.replace([9997, 9998, 9999], np.nan)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Then we compute each respondent’s age when married and age when interviewed:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">resp</span><span class="p">[</span><span class="s2">&quot;agemarry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">cmmarrhx</span> <span class="o">-</span> <span class="n">resp</span><span class="o">.</span><span class="n">cmbirth</span><span class="p">)</span> <span class="o">/</span> <span class="mf">12.0</span>
<span class="n">resp</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">cmintvw</span> <span class="o">-</span> <span class="n">resp</span><span class="o">.</span><span class="n">cmbirth</span><span class="p">)</span> <span class="o">/</span> <span class="mf">12.0</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 19;
                var nbb_unformatted_code = "resp[\"agemarry\"] = (resp.cmmarrhx - resp.cmbirth) / 12.0\nresp[\"age\"] = (resp.cmintvw - resp.cmbirth) / 12.0";
                var nbb_formatted_code = "resp[\"agemarry\"] = (resp.cmmarrhx - resp.cmbirth) / 12.0\nresp[\"age\"] = (resp.cmintvw - resp.cmbirth) / 12.0";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Next we extract <code class="docutils literal notranslate"><span class="pre">complete</span></code>, which is the age at marriage for women who have been married, and <code class="docutils literal notranslate"><span class="pre">ongoing</span></code>, which is the age at interview for women who have not:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">complete</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="n">resp</span><span class="o">.</span><span class="n">evrmarry</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">agemarry</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">ongoing</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="n">resp</span><span class="o">.</span><span class="n">evrmarry</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">age</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 20;
                var nbb_unformatted_code = "complete = resp[resp.evrmarry == 1].agemarry.dropna()\nongoing = resp[resp.evrmarry == 0].age";
                var nbb_formatted_code = "complete = resp[resp.evrmarry == 1].agemarry.dropna()\nongoing = resp[resp.evrmarry == 0].age";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Finally we compute the hazard function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hf</span> <span class="o">=</span> <span class="n">estimate_hazard_function</span><span class="p">(</span><span class="n">complete</span><span class="p">,</span> <span class="n">ongoing</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 21;
                var nbb_unformatted_code = "hf = estimate_hazard_function(complete, ongoing)";
                var nbb_formatted_code = "hf = estimate_hazard_function(complete, ongoing)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The following figure shows the estimated hazard function; it is low in the teens, higher in the 20s, and declining in the 30s.
It increases again in the 40s, but that is an artifact of the estimation process; as the number of respondents “at risk” decreases, a small number of women getting married yields a large estimated hazard.
The survival curve will smooth out this noise.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hf</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Age (years)&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Hazard&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/cd838e23a6a1a3d509643307bdc23475e9470f3ba70ee5a07af2c86dcbac4d9e.png" src="_images/cd838e23a6a1a3d509643307bdc23475e9470f3ba70ee5a07af2c86dcbac4d9e.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 22;
                var nbb_unformatted_code = "hf.plot()\ndecorate(xlabel=\"Age (years)\", ylabel=\"Hazard\")";
                var nbb_formatted_code = "hf.plot()\ndecorate(xlabel=\"Age (years)\", ylabel=\"Hazard\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
</section>
<section id="estimating-the-survival-curve">
<h2><span class="section-number">14.6. </span>Estimating the survival curve<a class="headerlink" href="#estimating-the-survival-curve" title="Link to this heading">#</a></h2>
<p>Once we have the hazard function, we can estimate the survival curve.
The chance of surviving past time <code class="docutils literal notranslate"><span class="pre">t</span></code> is the chance of surviving all times up through <code class="docutils literal notranslate"><span class="pre">t</span></code>, which is the cumulative product of the complementary hazard function:</p>
<div class="math notranslate nohighlight">
\[[1-\lambda(0)] [1-\lambda(1)] \ldots [1-\lambda(t)]\]</div>
<p>The <code class="docutils literal notranslate"><span class="pre">Hazard</span></code> class provides <code class="docutils literal notranslate"><span class="pre">make_surv</span></code>, which computes this product:</p>
<p><code class="docutils literal notranslate"><span class="pre">ts</span></code> is the sequence of times where the hazard function is estimated.
<code class="docutils literal notranslate"><span class="pre">ss</span></code> is the cumulative product of the complementary hazard function, so it is the survival curve.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sf</span> <span class="o">=</span> <span class="n">hf</span><span class="o">.</span><span class="n">make_surv</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 23;
                var nbb_unformatted_code = "sf = hf.make_surv()";
                var nbb_formatted_code = "sf = hf.make_surv()";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The following figure shows the result.
The survival curve is steepest between 25 and 35, when most women get married.
Between 35 and 45, the curve is nearly flat, indicating that women who do not marry before age 35 are unlikely to get married.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sf</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Age (years)&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Prob unmarried&quot;</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/7cd14d5334d4b4a2fa3bb8ff1696832d8fb7e104db833224c64861853894d46f.png" src="_images/7cd14d5334d4b4a2fa3bb8ff1696832d8fb7e104db833224c64861853894d46f.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 24;
                var nbb_unformatted_code = "sf.plot()\ndecorate(xlabel=\"Age (years)\", ylabel=\"Prob unmarried\", ylim=[0, 1])";
                var nbb_formatted_code = "sf.plot()\ndecorate(xlabel=\"Age (years)\", ylabel=\"Prob unmarried\", ylim=[0, 1])";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>A curve like this was the basis of a famous magazine article in 1986; <em>Newsweek</em> reported that a 40-year old unmarried woman was “more likely to be killed by a terrorist” than get married.
These statistics were widely reported and became part of popular culture, but they were wrong then (because they were based on faulty analysis) and turned out to be even more wrong (because of cultural changes that were already in progress and continued).
In 2006, <em>Newsweek</em> ran an another article admitting that they were wrong.</p>
<p>I encourage you to read more about this article, the statistics it was based on, and the reaction.
It should remind you of the ethical obligation to perform statistical analysis with care, interpret the results with appropriate skepticism, and present them to the public accurately and honestly.</p>
</section>
<section id="confidence-intervals">
<h2><span class="section-number">14.7. </span>Confidence intervals<a class="headerlink" href="#confidence-intervals" title="Link to this heading">#</a></h2>
<p>Kaplan-Meier analysis yields a single estimate of the survival curve, but it is also important to quantify the uncertainty of the estimate.
As usual, there are three possible sources of error: measurement error, sampling error, and modeling error.</p>
<p>In this example, measurement error is probably small.
People generally know when they were born, whether they’ve been married, and when.
And they can be expected to report this information accurately.</p>
<p>We can quantify sampling error by resampling.
Here’s the code:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">estimate_marriage_survival</span><span class="p">(</span><span class="n">resp</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Estimates the survival curve.</span>

<span class="sd">    resp: DataFrame of respondents</span>

<span class="sd">    returns: pair of `Hazard`, SurvivalFunction</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">complete</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="n">resp</span><span class="o">.</span><span class="n">evrmarry</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">agemarry</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="n">ongoing</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="n">resp</span><span class="o">.</span><span class="n">evrmarry</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">age</span>
    <span class="n">hf</span> <span class="o">=</span> <span class="n">estimate_hazard_function</span><span class="p">(</span><span class="n">complete</span><span class="p">,</span> <span class="n">ongoing</span><span class="p">)</span>
    <span class="n">sf</span> <span class="o">=</span> <span class="n">hf</span><span class="o">.</span><span class="n">make_surv</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">hf</span><span class="p">,</span> <span class="n">sf</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 27;
                var nbb_unformatted_code = "def estimate_marriage_survival(resp):\n    \"\"\"Estimates the survival curve.\n\n    resp: DataFrame of respondents\n\n    returns: pair of `Hazard`, SurvivalFunction\n    \"\"\"\n    complete = resp[resp.evrmarry == 1].agemarry.dropna()\n    ongoing = resp[resp.evrmarry == 0].age\n    hf = estimate_hazard_function(complete, ongoing)\n    sf = hf.make_surv()\n    return hf, sf";
                var nbb_formatted_code = "def estimate_marriage_survival(resp):\n    \"\"\"Estimates the survival curve.\n\n    resp: DataFrame of respondents\n\n    returns: pair of `Hazard`, SurvivalFunction\n    \"\"\"\n    complete = resp[resp.evrmarry == 1].agemarry.dropna()\n    ongoing = resp[resp.evrmarry == 0].age\n    hf = estimate_hazard_function(complete, ongoing)\n    sf = hf.make_surv()\n    return hf, sf";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">thinkstats</span> <span class="kn">import</span> <span class="n">resample_rows_weighted</span>
<span class="kn">from</span> <span class="nn">thinkstats</span> <span class="kn">import</span> <span class="n">percentile_rows</span>


<span class="k">def</span> <span class="nf">resample_survival</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">iters</span><span class="o">=</span><span class="mi">101</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Resamples respondents and estimates the survival function.</span>

<span class="sd">    resp: DataFrame of respondents</span>
<span class="sd">    iters: number of resamples</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">sf</span> <span class="o">=</span> <span class="n">estimate_marriage_survival</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span>
    <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">agemarry</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">resp</span><span class="o">.</span><span class="n">agemarry</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mf">12.0</span><span class="p">)</span>
    <span class="n">ss_seq</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iters</span><span class="p">):</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="n">resample_rows_weighted</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">sf</span> <span class="o">=</span> <span class="n">estimate_marriage_survival</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
        <span class="n">ss_seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sf</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span>

    <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="n">percentile_rows</span><span class="p">(</span><span class="n">ss_seq</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">95</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;90% CI&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 28;
                var nbb_unformatted_code = "from thinkstats import resample_rows_weighted\nfrom thinkstats import percentile_rows\n\n\ndef resample_survival(resp, iters=101):\n    \"\"\"Resamples respondents and estimates the survival function.\n\n    resp: DataFrame of respondents\n    iters: number of resamples\n    \"\"\"\n    _, sf = estimate_marriage_survival(resp)\n    plt.plot(sf)\n    low, high = resp.agemarry.min(), resp.agemarry.max()\n    ts = np.arange(low, high, 1 / 12.0)\n    ss_seq = []\n\n    for _ in range(iters):\n        sample = resample_rows_weighted(resp)\n        _, sf = estimate_marriage_survival(sample)\n        ss_seq.append(sf(ts))\n\n    low, high = percentile_rows(ss_seq, [5, 95])\n    plt.fill_between(ts, low, high, color=\"gray\", label=\"90% CI\")";
                var nbb_formatted_code = "from thinkstats import resample_rows_weighted\nfrom thinkstats import percentile_rows\n\n\ndef resample_survival(resp, iters=101):\n    \"\"\"Resamples respondents and estimates the survival function.\n\n    resp: DataFrame of respondents\n    iters: number of resamples\n    \"\"\"\n    _, sf = estimate_marriage_survival(resp)\n    plt.plot(sf)\n    low, high = resp.agemarry.min(), resp.agemarry.max()\n    ts = np.arange(low, high, 1 / 12.0)\n    ss_seq = []\n\n    for _ in range(iters):\n        sample = resample_rows_weighted(resp)\n        _, sf = estimate_marriage_survival(sample)\n        ss_seq.append(sf(ts))\n\n    low, high = percentile_rows(ss_seq, [5, 95])\n    plt.fill_between(ts, low, high, color=\"gray\", label=\"90% CI\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">resample_survival</span></code> takes <code class="docutils literal notranslate"><span class="pre">resp</span></code>, a <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> of respondents, and <code class="docutils literal notranslate"><span class="pre">iters</span></code>, the number of times to resample.
It computes <code class="docutils literal notranslate"><span class="pre">ts</span></code>, which is the sequence of ages where we will evaluate the survival curves.</p>
<p>Inside the loop, <code class="docutils literal notranslate"><span class="pre">resample_survival</span></code>:</p>
<ul class="simple">
<li><p>Resamples the respondents using <code class="docutils literal notranslate"><span class="pre">resample_rows_weighted</span></code>, which …</p></li>
<li><p>Calls <code class="docutils literal notranslate"><span class="pre">estimate_marriage_survival</span></code>, which uses the process in the previous sections to estimate the hazard and survival curves, and</p></li>
<li><p>Evaluates the survival curve at each age in <code class="docutils literal notranslate"><span class="pre">ts</span></code>.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">ss_seq</span></code> is a sequence of evaluated survival curves.
<code class="docutils literal notranslate"><span class="pre">percentile_rows</span></code> takes this sequence and computes the 5th and 95th percentiles, returning a 90% confidence interval for the survival curve.</p>
<p>The following figure shows the result along with the survival curve we estimated in the previous section.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">resample_survival</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>

<span class="n">decorate</span><span class="p">(</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Age (years)&quot;</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Prob unmarried&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/d5b6a709ab856737d90b374d0f8cf4393d0f491f4a6ecd8c9d393118604c3794.png" src="_images/d5b6a709ab856737d90b374d0f8cf4393d0f491f4a6ecd8c9d393118604c3794.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 29;
                var nbb_unformatted_code = "resample_survival(resp)\n\ndecorate(\n    xlabel=\"Age (years)\",\n    ylabel=\"Prob unmarried\",\n)";
                var nbb_formatted_code = "resample_survival(resp)\n\ndecorate(\n    xlabel=\"Age (years)\",\n    ylabel=\"Prob unmarried\",\n)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The confidence interval takes into account the sampling weights, unlike the estimated curve.
The discrepancy between them indicates that the sampling weights have a substantial effect on the estimate – we will have to keep that in mind.</p>
</section>
<section id="cohort-effects">
<h2><span class="section-number">14.8. </span>Cohort effects<a class="headerlink" href="#cohort-effects" title="Link to this heading">#</a></h2>
<p>One of the challenges of survival analysis is that different parts of the estimated curve are based on different groups of respondents.
The part of the curve at time <code class="docutils literal notranslate"><span class="pre">t</span></code> is based on respondents whose age was at least <code class="docutils literal notranslate"><span class="pre">t</span></code> when they were interviewed.
So the leftmost part of the curve includes data from all respondents, but the rightmost part includes only the oldest respondents.</p>
<p>If the relevant characteristics of the respondents are not changing over time, that’s fine, but in this case it seems likely that marriage patterns are different for women born in different generations.
We can investigate this effect by grouping respondents according to their decade of birth.
Groups like this, defined by date of birth or similar events, are called <strong>cohorts</strong>, and differences between the groups are called <strong>cohort effects</strong>.</p>
<p>To investigate cohort effects in the NSFG marriage data, I gathered the Cycle 6 data from 2002 used throughout this book, the Cycle 7 data from 2006–2010, and the Cycle 5 data from 1995.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">download</span><span class="p">(</span><span class="s2">&quot;https://github.com/AllenDowney/ThinkStats/raw/v3/data/1995FemRespData.dat.gz&quot;</span><span class="p">)</span>
<span class="n">download</span><span class="p">(</span>
    <span class="s2">&quot;https://github.com/AllenDowney/ThinkStats/raw/v3/data/2006_2010_FemRespSetup.dct&quot;</span>
<span class="p">)</span>
<span class="n">download</span><span class="p">(</span>
    <span class="s2">&quot;https://github.com/AllenDowney/ThinkStats/raw/v3/data/2006_2010_FemResp.dat.gz&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 30;
                var nbb_unformatted_code = "download(\"https://github.com/AllenDowney/ThinkStats/raw/v3/data/1995FemRespData.dat.gz\")\ndownload(\n    \"https://github.com/AllenDowney/ThinkStats/raw/v3/data/2006_2010_FemRespSetup.dct\"\n)\ndownload(\n    \"https://github.com/AllenDowney/ThinkStats/raw/v3/data/2006_2010_FemResp.dat.gz\"\n)";
                var nbb_formatted_code = "download(\"https://github.com/AllenDowney/ThinkStats/raw/v3/data/1995FemRespData.dat.gz\")\ndownload(\n    \"https://github.com/AllenDowney/ThinkStats/raw/v3/data/2006_2010_FemRespSetup.dct\"\n)\ndownload(\n    \"https://github.com/AllenDowney/ThinkStats/raw/v3/data/2006_2010_FemResp.dat.gz\"\n)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">resp5</span> <span class="o">=</span> <span class="n">nsfg</span><span class="o">.</span><span class="n">read_fem_resp1995</span><span class="p">()</span>
<span class="n">resp6</span> <span class="o">=</span> <span class="n">nsfg</span><span class="o">.</span><span class="n">read_fem_resp2002</span><span class="p">()</span>
<span class="n">resp7</span> <span class="o">=</span> <span class="n">nsfg</span><span class="o">.</span><span class="n">read_fem_resp2010</span><span class="p">()</span>
<span class="n">resps</span> <span class="o">=</span> <span class="p">[</span><span class="n">resp5</span><span class="p">,</span> <span class="n">resp6</span><span class="p">,</span> <span class="n">resp7</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 31;
                var nbb_unformatted_code = "resp5 = nsfg.read_fem_resp1995()\nresp6 = nsfg.read_fem_resp2002()\nresp7 = nsfg.read_fem_resp2010()\nresps = [resp5, resp6, resp7]";
                var nbb_formatted_code = "resp5 = nsfg.read_fem_resp1995()\nresp6 = nsfg.read_fem_resp2002()\nresp7 = nsfg.read_fem_resp2010()\nresps = [resp5, resp6, resp7]";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>For each <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> we can use <code class="docutils literal notranslate"><span class="pre">cmbirth</span></code> to compute the decade of birth for each respondent:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">resp</span> <span class="ow">in</span> <span class="n">resps</span><span class="p">:</span>
    <span class="n">month0</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s2">&quot;1899-12-15&quot;</span><span class="p">)</span>
    <span class="n">dates</span> <span class="o">=</span> <span class="p">[(</span><span class="n">month0</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="n">cm</span><span class="p">))</span> <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">resp</span><span class="o">.</span><span class="n">cmbirth</span><span class="p">]</span>
    <span class="n">resp</span><span class="p">[</span><span class="s2">&quot;decade&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span><span class="o">.</span><span class="n">year</span> <span class="o">-</span> <span class="mi">1900</span><span class="p">)</span> <span class="o">//</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 32;
                var nbb_unformatted_code = "for resp in resps:\n    month0 = pd.to_datetime(\"1899-12-15\")\n    dates = [(month0 + pd.DateOffset(months=cm)) for cm in resp.cmbirth]\n    resp[\"decade\"] = (pd.DatetimeIndex(dates).year - 1900) // 10";
                var nbb_formatted_code = "for resp in resps:\n    month0 = pd.to_datetime(\"1899-12-15\")\n    dates = [(month0 + pd.DateOffset(months=cm)) for cm in resp.cmbirth]\n    resp[\"decade\"] = (pd.DatetimeIndex(dates).year - 1900) // 10";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">cmbirth</span></code> is encoded as the integer number of months since December 1899; <code class="docutils literal notranslate"><span class="pre">month0</span></code> represents that date as a Timestamp object.
For each birth date, we instantiate a <code class="docutils literal notranslate"><span class="pre">DateOffset</span></code> that contains the century-month and add it to <code class="docutils literal notranslate"><span class="pre">month0</span></code>; the result is a sequence of Timestamps, which is converted to a <code class="docutils literal notranslate"><span class="pre">DateTimeIndex</span></code>.
Finally, we extract <code class="docutils literal notranslate"><span class="pre">year</span></code> and compute decades.</p>
<p>Intro…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_labels_by_decade</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Draws fake points in order to add labels to the legend.</span>

<span class="sd">    groups: GroupBy object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">0s&quot;</span> <span class="o">%</span> <span class="n">name</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">15</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 33;
                var nbb_unformatted_code = "def add_labels_by_decade(groups, **options):\n    \"\"\"Draws fake points in order to add labels to the legend.\n\n    groups: GroupBy object\n    \"\"\"\n    for name, _ in groups:\n        label = \"%d0s\" % name\n        plt.plot([15], [1], label=label, **options)";
                var nbb_formatted_code = "def add_labels_by_decade(groups, **options):\n    \"\"\"Draws fake points in order to add labels to the legend.\n\n    groups: GroupBy object\n    \"\"\"\n    for name, _ in groups:\n        label = \"%d0s\" % name\n        plt.plot([15], [1], label=label, **options)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">estimate_marriage_survival_by_decade</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Groups respondents by decade and plots survival curves.</span>

<span class="sd">    groups: GroupBy object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">sf</span> <span class="o">=</span> <span class="n">estimate_marriage_survival</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sf</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 34;
                var nbb_unformatted_code = "def estimate_marriage_survival_by_decade(groups, **options):\n    \"\"\"Groups respondents by decade and plots survival curves.\n\n    groups: GroupBy object\n    \"\"\"\n    for _, group in groups:\n        _, sf = estimate_marriage_survival(group)\n        plt.plot(sf, **options)";
                var nbb_formatted_code = "def estimate_marriage_survival_by_decade(groups, **options):\n    \"\"\"Groups respondents by decade and plots survival curves.\n\n    groups: GroupBy object\n    \"\"\"\n    for _, group in groups:\n        _, sf = estimate_marriage_survival(group)\n        plt.plot(sf, **options)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>To take into account the sampling weights, and also to show variability due to sampling error, I resample the data, group respondents by decade, and plot survival curves:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_resampled_by_decade</span><span class="p">(</span><span class="n">resps</span><span class="p">,</span> <span class="n">iters</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">predict_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">omit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plots survival curves for resampled data.</span>

<span class="sd">    resps: list of DataFrames</span>
<span class="sd">    iters: number of resamples to plot</span>
<span class="sd">    predict_flag: whether to also plot predictions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iters</span><span class="p">):</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="p">[</span><span class="n">resample_rows_weighted</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span> <span class="k">for</span> <span class="n">resp</span> <span class="ow">in</span> <span class="n">resps</span><span class="p">]</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">sample</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;decade&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">omit</span><span class="p">:</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="p">[(</span><span class="n">name</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">omit</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">add_labels_by_decade</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">predict_flag</span><span class="p">:</span>
            <span class="n">plot_predictions_by_decade</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">estimate_marriage_survival_by_decade</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">estimate_marriage_survival_by_decade</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 35;
                var nbb_unformatted_code = "def plot_resampled_by_decade(resps, iters=11, predict_flag=False, omit=None):\n    \"\"\"Plots survival curves for resampled data.\n\n    resps: list of DataFrames\n    iters: number of resamples to plot\n    predict_flag: whether to also plot predictions\n    \"\"\"\n    for i in range(iters):\n        samples = [resample_rows_weighted(resp) for resp in resps]\n        sample = pd.concat(samples, ignore_index=True)\n        groups = sample.groupby(\"decade\")\n        if omit:\n            groups = [(name, group) for name, group in groups if name not in omit]\n        if i == 0:\n            add_labels_by_decade(groups, alpha=0.7)\n        if predict_flag:\n            plot_predictions_by_decade(groups, alpha=0.1)\n            estimate_marriage_survival_by_decade(groups, alpha=0.1)\n        else:\n            estimate_marriage_survival_by_decade(groups, alpha=0.2)";
                var nbb_formatted_code = "def plot_resampled_by_decade(resps, iters=11, predict_flag=False, omit=None):\n    \"\"\"Plots survival curves for resampled data.\n\n    resps: list of DataFrames\n    iters: number of resamples to plot\n    predict_flag: whether to also plot predictions\n    \"\"\"\n    for i in range(iters):\n        samples = [resample_rows_weighted(resp) for resp in resps]\n        sample = pd.concat(samples, ignore_index=True)\n        groups = sample.groupby(\"decade\")\n        if omit:\n            groups = [(name, group) for name, group in groups if name not in omit]\n        if i == 0:\n            add_labels_by_decade(groups, alpha=0.7)\n        if predict_flag:\n            plot_predictions_by_decade(groups, alpha=0.1)\n            estimate_marriage_survival_by_decade(groups, alpha=0.1)\n        else:\n            estimate_marriage_survival_by_decade(groups, alpha=0.2)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Data from the three NSFG cycles use different sampling weights, so I resample them separately and then use <code class="docutils literal notranslate"><span class="pre">concat</span></code> to merge them into a single <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>.
The parameter <code class="docutils literal notranslate"><span class="pre">ignore_index</span></code> tells <code class="docutils literal notranslate"><span class="pre">concat</span></code> not to match up respondents by index; instead it creates a new index from 0 to 30768.</p>
<p><code class="docutils literal notranslate"><span class="pre">estimate_marriage_survival_by_decade</span></code> plots survival curves for each cohort:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_resampled_by_decade</span><span class="p">(</span><span class="n">resps</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Age (years)&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Prob unmarried&quot;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="mi">13</span><span class="p">,</span> <span class="mi">45</span><span class="p">],</span> <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/591e8b90e384269f12106e29d55826300ff088148ba11e67a979879c57378169.png" src="_images/591e8b90e384269f12106e29d55826300ff088148ba11e67a979879c57378169.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 36;
                var nbb_unformatted_code = "plot_resampled_by_decade(resps)\ndecorate(xlabel=\"Age (years)\", ylabel=\"Prob unmarried\", xlim=[13, 45], ylim=[0, 1])";
                var nbb_formatted_code = "plot_resampled_by_decade(resps)\ndecorate(xlabel=\"Age (years)\", ylabel=\"Prob unmarried\", xlim=[13, 45], ylim=[0, 1])";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Several patterns are visible:</p>
<ul class="simple">
<li><p>Women born in the 50s married earliest, with successive cohorts marrying later and later, at least until age 30 or so.</p></li>
<li><p>Women born in the 60s follow a surprising pattern.
Prior to age 25, they were marrying at slower rates than their predecessors.
After age 25, they were marrying faster.
By age 32 they had overtaken the 50s cohort, and at age 44 they are substantially more likely to have married.</p></li>
</ul>
<p>Women born in the 60s turned 25 between 1985 and 1995.
Remembering that the <em>Newsweek</em> article I mentioned was published in 1986, it is tempting to imagine that the article triggered a marriage boom.
That explanation would be too pat, but it is possible that the article and the reaction to it were indicative of a mood that affected the behavior of this cohort.</p>
<ul class="simple">
<li><p>The pattern of the 70s cohort is similar.
They are less likely than their predecessors to be married before age 25, but at age 35 they have caught up with both of the previous cohorts.</p></li>
<li><p>Women born in the 80s are even less likely to marry before age 25. What happens after that is not clear; for more data, we have to wait for the next cycle of the NSFG.</p></li>
</ul>
<p>In the meantime we can make some predictions.</p>
</section>
<section id="extrapolation">
<h2><span class="section-number">14.9. </span>Extrapolation<a class="headerlink" href="#extrapolation" title="Link to this heading">#</a></h2>
<p>The survival curve for the 70s cohort ends at about age 38; for the 80s cohort it ends at age 28, and for the 90s cohort we hardly have any data at all.</p>
<p>We can extrapolate these curves by “borrowing” data from the previous cohort.
<code class="docutils literal notranslate"><span class="pre">Hazard</span></code> provides a method, <code class="docutils literal notranslate"><span class="pre">Extend</span></code>, that copies the tail from another longer <code class="docutils literal notranslate"><span class="pre">Hazard</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">extend</span><span class="p">(</span><span class="n">haz1</span><span class="p">,</span> <span class="n">haz2</span><span class="p">):</span>
    <span class="n">last</span> <span class="o">=</span> <span class="n">haz1</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">more</span> <span class="o">=</span> <span class="n">haz2</span><span class="p">[</span><span class="n">haz2</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">last</span><span class="p">]</span>
    <span class="n">extended</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">haz1</span><span class="p">,</span> <span class="n">more</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">Hazard</span><span class="p">(</span><span class="n">extended</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 37;
                var nbb_unformatted_code = "def extend(haz1, haz2):\n    last = haz1.index[-1]\n    more = haz2[haz2.index > last]\n    extended = pd.concat([haz1, more])\n    return Hazard(extended)";
                var nbb_formatted_code = "def extend(haz1, haz2):\n    last = haz1.index[-1]\n    more = haz2[haz2.index > last]\n    extended = pd.concat([haz1, more])\n    return Hazard(extended)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">Hazard</span></code> contains a <code class="docutils literal notranslate"><span class="pre">Series</span></code> that maps from <span class="math notranslate nohighlight">\(t\)</span> to <span class="math notranslate nohighlight">\(\lambda(t)\)</span>.
<code class="docutils literal notranslate"><span class="pre">Extend</span></code> finds <code class="docutils literal notranslate"><span class="pre">last</span></code>, which is the last index in <code class="docutils literal notranslate"><span class="pre">self.series</span></code>, selects values from <code class="docutils literal notranslate"><span class="pre">other</span></code> that come later than <code class="docutils literal notranslate"><span class="pre">last</span></code>, and appends them onto <code class="docutils literal notranslate"><span class="pre">self.series</span></code>.</p>
<p>Now we can extend the <code class="docutils literal notranslate"><span class="pre">Hazard</span></code> for each cohort, using values from the predecessor:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_predictions_by_decade</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Groups respondents by decade and plots survival curves.</span>

<span class="sd">    groups: GroupBy object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
        <span class="n">hf</span><span class="p">,</span> <span class="n">sf</span> <span class="o">=</span> <span class="n">estimate_marriage_survival</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
        <span class="n">hfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hf</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">hf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hfs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">hf</span> <span class="o">=</span> <span class="n">extend</span><span class="p">(</span><span class="n">hf</span><span class="p">,</span> <span class="n">hfs</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">hfs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">hf</span>
        <span class="n">sf</span> <span class="o">=</span> <span class="n">hf</span><span class="o">.</span><span class="n">make_surv</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sf</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 38;
                var nbb_unformatted_code = "def plot_predictions_by_decade(groups, **options):\n    \"\"\"Groups respondents by decade and plots survival curves.\n\n    groups: GroupBy object\n    \"\"\"\n    hfs = []\n    for _, group in groups:\n        hf, sf = estimate_marriage_survival(group)\n        hfs.append(hf)\n\n    for i, hf in enumerate(hfs):\n        if i > 0:\n            hf = extend(hf, hfs[i - 1])\n            hfs[i] = hf\n        sf = hf.make_surv()\n        plt.plot(sf, **options)";
                var nbb_formatted_code = "def plot_predictions_by_decade(groups, **options):\n    \"\"\"Groups respondents by decade and plots survival curves.\n\n    groups: GroupBy object\n    \"\"\"\n    hfs = []\n    for _, group in groups:\n        hf, sf = estimate_marriage_survival(group)\n        hfs.append(hf)\n\n    for i, hf in enumerate(hfs):\n        if i > 0:\n            hf = extend(hf, hfs[i - 1])\n            hfs[i] = hf\n        sf = hf.make_surv()\n        plt.plot(sf, **options)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">groups</span></code> is a GroupBy object with respondents grouped by decade of birth.
The first loop computes the <code class="docutils literal notranslate"><span class="pre">Hazard</span></code> for each group.</p>
<p>The second loop extends each <code class="docutils literal notranslate"><span class="pre">Hazard</span></code> with values from its predecessor, which might contain values from the previous group, and so on. Then it converts each <code class="docutils literal notranslate"><span class="pre">Hazard</span></code> to a SurvivalFunction and plots it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_resampled_by_decade</span><span class="p">(</span><span class="n">resps</span><span class="p">,</span> <span class="n">predict_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Age (years)&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Prob unmarried&quot;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="mi">13</span><span class="p">,</span> <span class="mi">45</span><span class="p">],</span> <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/1420bd14f048a69a40dc36367acc5d180f48c9f49e708d9078373c852f1e47ee.png" src="_images/1420bd14f048a69a40dc36367acc5d180f48c9f49e708d9078373c852f1e47ee.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 39;
                var nbb_unformatted_code = "plot_resampled_by_decade(resps, predict_flag=True)\ndecorate(xlabel=\"Age (years)\", ylabel=\"Prob unmarried\", xlim=[13, 45], ylim=[0, 1])";
                var nbb_formatted_code = "plot_resampled_by_decade(resps, predict_flag=True)\ndecorate(xlabel=\"Age (years)\", ylabel=\"Prob unmarried\", xlim=[13, 45], ylim=[0, 1])";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>I’ve removed the 50s cohort to make the predictions more visible.
These results suggest that by age 40, the most recent cohorts will converge with the 60s cohort, with fewer than 20% never married.</p>
</section>
<section id="expected-remaining-lifetime">
<h2><span class="section-number">14.10. </span>Expected remaining lifetime<a class="headerlink" href="#expected-remaining-lifetime" title="Link to this heading">#</a></h2>
<p>Given a survival curve, we can compute the expected remaining lifetime as a function of current age.
For example, given the survival curve of pregnancy length, we can compute the expected time until delivery.</p>
<p>The first step is to extract the PMF of lifetimes.
<code class="docutils literal notranslate"><span class="pre">SurvivalFunction</span></code> provides a method that does that:</p>
<p>Remember that the SurvivalFunction contains the <code class="docutils literal notranslate"><span class="pre">Cdf</span></code> of lifetimes.
The loop copies the values and probabilities from the <code class="docutils literal notranslate"><span class="pre">Cdf</span></code> into a <code class="docutils literal notranslate"><span class="pre">Pmf</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">cutoff</span></code> is the highest probability in the <code class="docutils literal notranslate"><span class="pre">Cdf</span></code>, which is 1 if the <code class="docutils literal notranslate"><span class="pre">Cdf</span></code> is complete, and otherwise less than 1. If the <code class="docutils literal notranslate"><span class="pre">Cdf</span></code> is incomplete, we plug in the provided value, <code class="docutils literal notranslate"><span class="pre">filler</span></code>, to cap it off.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Cdf</span></code> of pregnancy lengths is complete, so we don’t have to worry about this detail yet.</p>
<p>The next step is to compute the expected remaining lifetime, where “expected” means average.
<code class="docutils literal notranslate"><span class="pre">SurvivalFunction</span></code> provides a method that does that, too:</p>
<p><code class="docutils literal notranslate"><span class="pre">RemainingLifetime</span></code> takes <code class="docutils literal notranslate"><span class="pre">filler</span></code>, which is passed along to <code class="docutils literal notranslate"><span class="pre">MakePmf</span></code>, and <code class="docutils literal notranslate"><span class="pre">func</span></code> which is the function used to summarize the distribution of remaining lifetimes.</p>
<p><code class="docutils literal notranslate"><span class="pre">pmf</span></code> is the <code class="docutils literal notranslate"><span class="pre">Pmf</span></code> of lifetimes extracted from the SurvivalFunction.
<code class="docutils literal notranslate"><span class="pre">d</span></code> is a dictionary that contains the results, a map from current age, <code class="docutils literal notranslate"><span class="pre">t</span></code>, to expected remaining lifetime.</p>
<p>The loop iterates through the values in the <code class="docutils literal notranslate"><span class="pre">Pmf</span></code>.
For each value of <code class="docutils literal notranslate"><span class="pre">t</span></code> it computes the conditional distribution of lifetimes, given that the lifetime exceeds <code class="docutils literal notranslate"><span class="pre">t</span></code>.
It does that by removing values from the <code class="docutils literal notranslate"><span class="pre">Pmf</span></code> one at a time and renormalizing the remaining values.</p>
<p>Then it uses <code class="docutils literal notranslate"><span class="pre">func</span></code> to summarize the conditional distribution.
In this example the result is the mean pregnancy length, given that the length exceeds <code class="docutils literal notranslate"><span class="pre">t</span></code>.
By subtracting <code class="docutils literal notranslate"><span class="pre">t</span></code> we get the mean remaining pregnancy length.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preg</span> <span class="o">=</span> <span class="n">nsfg</span><span class="o">.</span><span class="n">read_fem_preg</span><span class="p">()</span>
<span class="n">complete</span> <span class="o">=</span> <span class="n">preg</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;outcome in [1, 3, 4]&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">prglngth</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of complete pregnancies&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">complete</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number of complete pregnancies 11189
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 40;
                var nbb_unformatted_code = "preg = nsfg.read_fem_preg()\ncomplete = preg.query(\"outcome in [1, 3, 4]\").prglngth\nprint(\"Number of complete pregnancies\", len(complete))";
                var nbb_formatted_code = "preg = nsfg.read_fem_preg()\ncomplete = preg.query(\"outcome in [1, 3, 4]\").prglngth\nprint(\"Number of complete pregnancies\", len(complete))";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ongoing</span> <span class="o">=</span> <span class="n">preg</span><span class="p">[</span><span class="n">preg</span><span class="o">.</span><span class="n">outcome</span> <span class="o">==</span> <span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">prglngth</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of ongoing pregnancies&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ongoing</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number of ongoing pregnancies 352
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 41;
                var nbb_unformatted_code = "ongoing = preg[preg.outcome == 6].prglngth\nprint(\"Number of ongoing pregnancies\", len(ongoing))";
                var nbb_formatted_code = "ongoing = preg[preg.outcome == 6].prglngth\nprint(\"Number of ongoing pregnancies\", len(ongoing))";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hf</span> <span class="o">=</span> <span class="n">estimate_hazard_function</span><span class="p">(</span><span class="n">complete</span><span class="p">,</span> <span class="n">ongoing</span><span class="p">)</span>
<span class="n">sf1</span> <span class="o">=</span> <span class="n">hf</span><span class="o">.</span><span class="n">make_surv</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 42;
                var nbb_unformatted_code = "hf = estimate_hazard_function(complete, ongoing)\nsf1 = hf.make_surv()";
                var nbb_formatted_code = "hf = estimate_hazard_function(complete, ongoing)\nsf1 = hf.make_surv()";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">empiricaldist</span> <span class="kn">import</span> <span class="n">Pmf</span>


<span class="k">def</span> <span class="nf">remaining_lifetime</span><span class="p">(</span><span class="n">surv</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">Pmf</span><span class="o">.</span><span class="n">mean</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes remaining lifetime as a function of age.</span>

<span class="sd">    func: function from conditional Pmf to remaining lifetime</span>

<span class="sd">    returns: Series that maps from age to remaining lifetime</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pmf</span> <span class="o">=</span> <span class="n">surv</span><span class="o">.</span><span class="n">make_pmf</span><span class="p">()</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">pmf</span><span class="o">.</span><span class="n">qs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">pmf</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pmf</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
        <span class="n">d</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">pmf</span><span class="p">)</span> <span class="o">-</span> <span class="n">t</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 43;
                var nbb_unformatted_code = "from empiricaldist import Pmf\n\n\ndef remaining_lifetime(surv, func=Pmf.mean):\n    \"\"\"Computes remaining lifetime as a function of age.\n\n    func: function from conditional Pmf to remaining lifetime\n\n    returns: Series that maps from age to remaining lifetime\n    \"\"\"\n    pmf = surv.make_pmf()\n    d = {}\n    for t in pmf.qs[:-1]:\n        pmf[t] = 0\n        pmf.normalize()\n        d[t] = func(pmf) - t\n    return pd.Series(d)";
                var nbb_formatted_code = "from empiricaldist import Pmf\n\n\ndef remaining_lifetime(surv, func=Pmf.mean):\n    \"\"\"Computes remaining lifetime as a function of age.\n\n    func: function from conditional Pmf to remaining lifetime\n\n    returns: Series that maps from age to remaining lifetime\n    \"\"\"\n    pmf = surv.make_pmf()\n    d = {}\n    for t in pmf.qs[:-1]:\n        pmf[t] = 0\n        pmf.normalize()\n        d[t] = func(pmf) - t\n    return pd.Series(d)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Here’s expected remaining pregnancy length as a function of the current duration.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rem_life1</span> <span class="o">=</span> <span class="n">remaining_lifetime</span><span class="p">(</span><span class="n">sf1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rem_life1</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Remaining pregnancy length&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Weeks&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Mean remaining weeks&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/62060e09fc0cf3bc8b1471620e12ca4f7474d8a574981744a7a65930f41ef754.png" src="_images/62060e09fc0cf3bc8b1471620e12ca4f7474d8a574981744a7a65930f41ef754.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 44;
                var nbb_unformatted_code = "rem_life1 = remaining_lifetime(sf1)\nplt.plot(rem_life1)\ndecorate(\n    title=\"Remaining pregnancy length\", xlabel=\"Weeks\", ylabel=\"Mean remaining weeks\"\n)";
                var nbb_formatted_code = "rem_life1 = remaining_lifetime(sf1)\nplt.plot(rem_life1)\ndecorate(\n    title=\"Remaining pregnancy length\", xlabel=\"Weeks\", ylabel=\"Mean remaining weeks\"\n)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>For example, during Week 0, the expected remaining duration is about 34 weeks.
That’s less than full term (39 weeks) because terminations of pregnancy in the first trimester bring the average down.</p>
<p>The curve drops slowly during the first trimester.
After 13 weeks, the expected remaining lifetime has dropped by only 9 weeks, to 25. After that the curve drops faster, by about a week per week.</p>
<p>Between Week 37 and 42, the curve levels off between 1 and 2 weeks.
At any time during this period, the expected remaining lifetime is the same; with each week that passes, the destination gets no closer.
Processes with this property are called <strong>memoryless</strong> because the past has no effect on the predictions.
This behavior is the mathematical basis of the infuriating mantra of obstetrics nurses: “Any day now.”</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hf</span><span class="p">,</span> <span class="n">sf2</span> <span class="o">=</span> <span class="n">estimate_marriage_survival</span><span class="p">(</span><span class="n">resp6</span><span class="p">)</span>
<span class="n">sf2</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">decorate</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/a23d8909443914b3aa1cd3d7d52ea76212bd097973e8baa54a1e6d29cff4d0d2.png" src="_images/a23d8909443914b3aa1cd3d7d52ea76212bd097973e8baa54a1e6d29cff4d0d2.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 45;
                var nbb_unformatted_code = "hf, sf2 = estimate_marriage_survival(resp6)\nsf2.plot()\ndecorate()";
                var nbb_formatted_code = "hf, sf2 = estimate_marriage_survival(resp6)\nsf2.plot()\ndecorate()";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>TODO: Explain why we need these adjustments</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sf2</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">pmf</span><span class="p">:</span> <span class="n">pmf</span><span class="o">.</span><span class="n">make_cdf</span><span class="p">()</span><span class="o">.</span><span class="n">inverse</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 46;
                var nbb_unformatted_code = "sf2[np.inf] = 0\n\nfunc = lambda pmf: pmf.make_cdf().inverse(0.5)";
                var nbb_formatted_code = "sf2[np.inf] = 0\n\nfunc = lambda pmf: pmf.make_cdf().inverse(0.5)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The following figure shows the median remaining time until first marriage, as a function of age.
For an 11 year-old girl, the median time until first marriage is about 14 years.
The curve decreases until age 22 when the median remaining time is about 7 years.
After that it increases again: by age 30 it is back where it started, at 14 years.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rem_life2</span> <span class="o">=</span> <span class="n">remaining_lifetime</span><span class="p">(</span><span class="n">sf2</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rem_life2</span><span class="p">)</span>

<span class="n">decorate</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Years until first marriage&quot;</span><span class="p">,</span>
    <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">],</span>
    <span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">31</span><span class="p">],</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Age (years)&quot;</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Median remaining years&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/838c07a3897e733c3e3505722de1d3b8e163b3ebdf2bdafd4276b1ae4a1cebcc.png" src="_images/838c07a3897e733c3e3505722de1d3b8e163b3ebdf2bdafd4276b1ae4a1cebcc.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 47;
                var nbb_unformatted_code = "rem_life2 = remaining_lifetime(sf2, func=func)\nplt.plot(rem_life2)\n\ndecorate(\n    title=\"Years until first marriage\",\n    ylim=[0, 15],\n    xlim=[11, 31],\n    xlabel=\"Age (years)\",\n    ylabel=\"Median remaining years\",\n)";
                var nbb_formatted_code = "rem_life2 = remaining_lifetime(sf2, func=func)\nplt.plot(rem_life2)\n\ndecorate(\n    title=\"Years until first marriage\",\n    ylim=[0, 15],\n    xlim=[11, 31],\n    xlabel=\"Age (years)\",\n    ylabel=\"Median remaining years\",\n)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Based on this data, young women have decreasing remaining “lifetimes”.
Mechanical components with this property are called <strong>NBUE</strong> for “new better than used in expectation,” meaning that a new part is expected to last longer.</p>
<p>Women older than 22 have increasing remaining time until first marriage.
Components with this property are called <strong>UBNE</strong> for “used better than new in expectation.” That is, the older the part, the longer it is expected to last.
Newborns and cancer patients are also UBNE; their life expectancy increases the longer they live.</p>
<p>For this example I computed median, rather than mean, because the <code class="docutils literal notranslate"><span class="pre">Cdf</span></code> is incomplete; the survival curve projects that about 20% of respondents will not marry before age 44. The age of first marriage for these women is unknown, and might be non-existent, so we can’t compute a mean.</p>
<p>I deal with these unknown values by replacing them with <code class="docutils literal notranslate"><span class="pre">np.inf</span></code>, a special value that represents infinity.
That makes the mean infinity for all ages, but the median is well-defined as long as more than 50% of the remaining lifetimes are finite, which is true until age 30. After that it is hard to define a meaningful expected remaining lifetime.</p>
</section>
<section id="glossary">
<h2><span class="section-number">14.11. </span>Glossary<a class="headerlink" href="#glossary" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>survival analysis</strong>: A set of methods for describing and predicting lifetimes, or more generally time until an event occurs.</p></li>
<li><p><strong>survival curve</strong>: A function that maps from a time, <span class="math notranslate nohighlight">\(t\)</span>, to the probability of surviving past <span class="math notranslate nohighlight">\(t\)</span>.</p></li>
<li><p><strong>hazard function</strong>: A function that maps from <span class="math notranslate nohighlight">\(t\)</span> to the fraction of people alive until <span class="math notranslate nohighlight">\(t\)</span> who die at <span class="math notranslate nohighlight">\(t\)</span>.</p></li>
<li><p><strong>Kaplan-Meier estimation</strong>: An algorithm for estimating hazard and survival functions.</p></li>
<li><p><strong>cohort</strong>: a group of subjects defined by an event, like date of birth, in a particular interval of time.</p></li>
<li><p><strong>cohort effect</strong>: a difference between cohorts.</p></li>
<li><p><strong>NBUE</strong>: A property of expected remaining lifetime, “New better than used in expectation.”</p></li>
<li><p><strong>UBNE</strong>: A property of expected remaining lifetime, “Used better than new in expectation.”</p></li>
</ul>
</section>
<section id="exercises">
<h2><span class="section-number">14.12. </span>Exercises<a class="headerlink" href="#exercises" title="Link to this heading">#</a></h2>
<p><strong>Exercise:</strong>    In NSFG Cycles 6 and 7, the variable <code class="docutils literal notranslate"><span class="pre">cmdivorcx</span></code> contains the date of divorce for the respondent’s first marriage, if applicable, encoded in century-months.</p>
<p>Compute the duration of marriages that have ended in divorce, and the duration, so far, of marriages that are ongoing.
Estimate the hazard and survival curve for the duration of marriage.</p>
<p>Use resampling to take into account sampling weights, and plot data from several resamples to visualize sampling error.</p>
<p>Consider dividing the respondents into groups by decade of birth, and possibly by age at first marriage.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">clean_data</span><span class="p">(</span><span class="n">resp</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cleans respondent data.</span>

<span class="sd">    resp: DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">resp</span><span class="p">[</span><span class="s2">&quot;cmdivorcx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">cmdivorcx</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="mi">9998</span><span class="p">,</span> <span class="mi">9999</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">resp</span><span class="p">[</span><span class="s2">&quot;notdivorced&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">cmdivorcx</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">resp</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">cmdivorcx</span> <span class="o">-</span> <span class="n">resp</span><span class="o">.</span><span class="n">cmmarrhx</span><span class="p">)</span> <span class="o">/</span> <span class="mf">12.0</span>
    <span class="n">resp</span><span class="p">[</span><span class="s2">&quot;durationsofar&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">cmintvw</span> <span class="o">-</span> <span class="n">resp</span><span class="o">.</span><span class="n">cmmarrhx</span><span class="p">)</span> <span class="o">/</span> <span class="mf">12.0</span>
    <span class="n">month0</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s2">&quot;1899-12-15&quot;</span><span class="p">)</span>
    <span class="n">dates</span> <span class="o">=</span> <span class="p">[(</span><span class="n">month0</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="n">cm</span><span class="p">))</span> <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">resp</span><span class="o">.</span><span class="n">cmbirth</span><span class="p">]</span>
    <span class="n">resp</span><span class="p">[</span><span class="s2">&quot;decade&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span><span class="o">.</span><span class="n">year</span> <span class="o">-</span> <span class="mi">1900</span><span class="p">)</span> <span class="o">//</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 48;
                var nbb_unformatted_code = "def clean_data(resp):\n    \"\"\"Cleans respondent data.\n\n    resp: DataFrame\n    \"\"\"\n    resp[\"cmdivorcx\"] = resp.cmdivorcx.replace([9998, 9999], np.nan)\n    resp[\"notdivorced\"] = resp.cmdivorcx.isnull().astype(int)\n    resp[\"duration\"] = (resp.cmdivorcx - resp.cmmarrhx) / 12.0\n    resp[\"durationsofar\"] = (resp.cmintvw - resp.cmmarrhx) / 12.0\n    month0 = pd.to_datetime(\"1899-12-15\")\n    dates = [(month0 + pd.DateOffset(months=cm)) for cm in resp.cmbirth]\n    resp[\"decade\"] = (pd.DatetimeIndex(dates).year - 1900) // 10";
                var nbb_formatted_code = "def clean_data(resp):\n    \"\"\"Cleans respondent data.\n\n    resp: DataFrame\n    \"\"\"\n    resp[\"cmdivorcx\"] = resp.cmdivorcx.replace([9998, 9999], np.nan)\n    resp[\"notdivorced\"] = resp.cmdivorcx.isnull().astype(int)\n    resp[\"duration\"] = (resp.cmdivorcx - resp.cmmarrhx) / 12.0\n    resp[\"durationsofar\"] = (resp.cmintvw - resp.cmmarrhx) / 12.0\n    month0 = pd.to_datetime(\"1899-12-15\")\n    dates = [(month0 + pd.DateOffset(months=cm)) for cm in resp.cmbirth]\n    resp[\"decade\"] = (pd.DatetimeIndex(dates).year - 1900) // 10";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clean_data</span><span class="p">(</span><span class="n">resp6</span><span class="p">)</span>
<span class="n">married6</span> <span class="o">=</span> <span class="n">resp6</span><span class="p">[</span><span class="n">resp6</span><span class="o">.</span><span class="n">evrmarry</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">clean_data</span><span class="p">(</span><span class="n">resp7</span><span class="p">)</span>
<span class="n">married7</span> <span class="o">=</span> <span class="n">resp7</span><span class="p">[</span><span class="n">resp7</span><span class="o">.</span><span class="n">evrmarry</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 49;
                var nbb_unformatted_code = "clean_data(resp6)\nmarried6 = resp6[resp6.evrmarry == 1]\nclean_data(resp7)\nmarried7 = resp7[resp7.evrmarry == 1]";
                var nbb_formatted_code = "clean_data(resp6)\nmarried6 = resp6[resp6.evrmarry == 1]\nclean_data(resp7)\nmarried7 = resp7[resp7.evrmarry == 1]";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="chap12.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">13. </span>Time series analysis</p>
      </div>
    </a>
    <a class="right-next"
       href="chap14.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">15. </span>Analytic methods</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#survival-curves">14.1. Survival curves</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#hazard-function">14.2. Hazard function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#inferring-survival-curves">14.3. Inferring survival curves</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#kaplan-meier-estimation">14.4. Kaplan-Meier estimation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-marriage-curve">14.5. The marriage curve</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#estimating-the-survival-curve">14.6. Estimating the survival curve</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#confidence-intervals">14.7. Confidence intervals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cohort-effects">14.8. Cohort effects</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extrapolation">14.9. Extrapolation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#expected-remaining-lifetime">14.10. Expected remaining lifetime</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#glossary">14.11. Glossary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">14.12. Exercises</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Allen B. Downey
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>